<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Segnalazioni Condominio Piazza Guala</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#cc0000">

<style>
:root {
  --primary: #cc0000;
  --bg: #f3f4f6;
  --card-bg: #f7f7f7;
  --border: #cc0000;
  --shadow: 0 4px 14px rgba(0,0,0,0.12);
  --shadow-strong: 0 6px 22px rgba(204,0,0,0.45);
  --chat-blue: #0066ff;
  --chat-yellow: #ffcc00;
  --chat-orange: #ff8800;
  --chat-red: #ff0022;
}

body {
  background: var(--bg);
  margin: 0;
  padding: 1rem;
  font-family: system-ui, sans-serif;
}

/* --- TUTTO COME IL TUO FILE ORIGINALE --- */
.container{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;}
@media(max-width:900px){.container{grid-template-columns:1fr;}}
.scalaBox{background:white;padding:1rem;border-radius:1rem;box-shadow:var(--shadow);max-height:87vh;overflow-y:auto;}
.card{position:relative;background:var(--card-bg);border:2px solid var(--border);border-radius:1rem;padding:.6rem;text-align:center;font-weight:bold;cursor:pointer;box-shadow:var(--shadow);transition:.15s;}
.card:hover{transform:translateY(-3px);box-shadow:var(--shadow-strong);}
.tempBox{display:flex;justify-content:center;align-items:center;gap:4px;margin-top:3px;font-size:.85rem;}
.tempDot{width:12px;height:12px;border-radius:50%;}
.t-blue{background:#0077ff;} .t-yellow{background:#ffcc00;} .t-red{background:#d50000;}

/* CHAT ICON */
.chatIcon{
  position:absolute;top:-10px;right:-10px;width:42px;height:42px;
  background:var(--chat-blue);
  border-radius:50%;display:flex;justify-content:center;align-items:center;
  box-shadow:0 4px 10px rgba(0,0,0,.35),inset 0 2px 4px rgba(255,255,255,.4),inset 0 -3px 6px rgba(0,0,0,.2);
  cursor:pointer;z-index:20;
}
.chatIcon img{width:22px;filter:invert(100%);}
.chatBadge{
  position:absolute;bottom:-6px;right:-6px;background:#000;color:white;
  padding:2px 7px;font-size:13px;border-radius:12px;font-weight:bold;
  box-shadow:0 2px 8px rgba(0,0,0,.4);
}
.badge-0{background:#0077ff;}
.badge-1{background:#ffcc00;}
.badge-3{background:#ff8800;}
.badge-4p{background:#ff0022;animation:pulseRed 1s infinite;}
@keyframes pulseRed{0%,100%{transform:scale(1);}50%{transform:scale(1.15);}}

/* CHAT WINDOW */
.chatWindow{position:fixed;bottom:0;left:0;right:0;height:58vh;background:white;
  border-radius:18px 18px 0 0;box-shadow:0 -3px 18px rgba(0,0,0,.25);
  display:none;flex-direction:column;z-index:99999;}
.chatHeader{padding:14px;background:var(--primary);color:white;text-align:center;font-weight:bold;}
.chatMessages{flex:1;overflow-y:auto;padding:12px;}
.chatInputBox{display:flex;padding:10px;border-top:1px solid #ddd;}
.chatInputBox input{flex:1;padding:10px;border-radius:10px;border:1px solid #ccc;}
.chatInputBox button{margin-left:8px;background:var(--primary);color:white;padding:10px 16px;border-radius:10px;border:none;cursor:pointer;}

.msgUser{background:#d8ecff;padding:8px 12px;border-radius:12px;margin:6px 0;max-width:78%;align-self:flex-end;}
.msgAdmin{background:#e8e8e8;padding:8px 12px;border-radius:12px;margin:6px 0;max-width:78%;align-self:flex-start;}
.msgInfo{text-align:center;font-size:.8rem;color:#777;margin:8px 0;}

</style>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyAneaPGbeUWMNurMzGghrOoYpw4dsuIwr4",
  authDomain:"segnalazioni-guala.firebaseapp.com",
  projectId:"segnalazioni-guala",
  storageBucket:"segnalazioni-guala.firebasestorage.app",
  messagingSenderId:"118462666966",
  appId:"1:118462666966:web:9ca2cdb6985581fe79d177"
});
const db=firebase.firestore();
</script>
</head>

<body>

<h1>APP DEDICATA ALLE SEGNALAZIONI DEL CONDOMINIO</h1>
<h2>Piazza Guala â€¢ Via Piobesi</h2>

<!-- CHAT -->
<div id="chatWindow" class="chatWindow">
  <div id="chatHeader" class="chatHeader">Chat</div>
  <div id="chatMessages" class="chatMessages"></div>
  <div id="chatInputBox" class="chatInputBox">
    <input id="chatInput" placeholder="Scrivi un messaggio...">
    <button onclick="sendChatMessage()">Invia</button>
  </div>
</div>

<div class="container"></div>
<script>
/* ========== FIX CRITICO ==========
   ID CHAT SICURI (NESSUN "/" PERMESSO)
====================================*/
function buildChatId(scala,piano,lato,nome){
  const cleanScala = scala.replace(/[^A-Za-z0-9]/g,"");
  const cleanPiano = String(piano).replace(/[^A-Za-z0-9]/g,"");
  const cleanLato  = lato.replace(/[^A-Za-z0-9]/g,"");
  const cleanNome  = nome.replace(/[^A-Za-z0-9]/g,"");
  return `${cleanScala}-${cleanPiano}-${cleanLato}-${cleanNome}`;
}

/* ========== OPEN CHAT ========== */
let currentChatId=null;
let unsubscribeChat=null;
let chatClosed=false;

function openChat(scala,piano,lato,nome){
  currentChatId = buildChatId(scala,piano,lato,nome);
  chatClosed = false;

  document.getElementById("chatHeader").innerText =
    `${scala} â€¢ ${piano} â€¢ ${lato} â€¢ ${nome}`;
  document.getElementById("chatWindow").style.display="flex";

  loadChatMessages(currentChatId);
}

function openChatFromIcon(e,scala,piano,lato,nome){
  e.stopPropagation();
  openChat(scala,piano,lato,nome);
}

/* ========== LOAD CHAT (FIX) ========== */
function loadChatMessages(chatId){
  const chatMessagesEl=document.getElementById("chatMessages");
  chatMessagesEl.innerHTML="";

  if(unsubscribeChat) unsubscribeChat();

  unsubscribeChat = db.collection("chat")
    .doc(chatId)
    .collection("messages")
    .orderBy("timestamp")
    .onSnapshot(snap=>{
      chatMessagesEl.innerHTML="";
      snap.forEach(doc=>{
        const msg=doc.data();
        let d=document.createElement("div");
        if(msg.system) d.className="msgInfo";
        else if(msg.sender==="utente") d.className="msgUser";
        else d.className="msgAdmin";
        d.innerText=msg.text;
        chatMessagesEl.appendChild(d);
      });
      chatMessagesEl.scrollTop=chatMessagesEl.scrollHeight;
      updateBadgeCount(chatId,snap.size);
    });
}

/* ========== SEND MESSAGE (FIX) ========== */
function sendChatMessage(){
  if(chatClosed){alert("Chat chiusa dall'amministratore.");return;}
  const input=document.getElementById("chatInput");
  const text=input.value.trim(); if(!text) return;

  db.collection("chat").doc(currentChatId)
    .collection("messages")
    .add({
      sender:"utente",
      text,
      timestamp:firebase.firestore.FieldValue.serverTimestamp()
    });

  input.value="";
}

/* ========== UPDATE BADGE ========== */
function updateBadgeCount(chatId,count){
  document.querySelectorAll(".card").forEach(card=>{
    const id=buildChatId(card.dataset.scala,card.dataset.piano,card.dataset.lato,card.dataset.nome);
    if(id!==chatId) return;
    const badge=card.querySelector(".chatBadge");
    const icon=card.querySelector(".chatIcon");
    badge.innerText=count;
    if(count===0){badge.className="chatBadge badge-0";icon.style.background="var(--chat-blue)";}
    else if(count<=2){badge.className="chatBadge badge-1";icon.style.background="var(--chat-yellow)";}
    else if(count===3){badge.className="chatBadge badge-3";icon.style.background="var(--chat-orange)";}
    else{badge.className="chatBadge badge-4p";icon.style.background="var(--chat-red)";}
  });
}
/* ========== CREA SEGNALAZIONE + CHAT FIX ========== */
function inviaSegnalazioneFinale(){
  const temp=document.getElementById("tempInput").value || "ND";
  const desc=document.getElementById("descrizioneInput").value.trim() || "Nessuna descrizione";
  const tipo=document.getElementById("tipoInput").value;
  const sotto=document.getElementById("selectPartiComuni").value;

  let priorita="VERDE";
  if(["118","112","115"].includes(tipo)) priorita="ROSSO";
  else if(["ascensore","elettricista","idraulico","centrale","autoclave"].includes(tipo)) priorita="ARANCIONE";
  else if(["serramenti","antincendio","particomuni"].includes(tipo)) priorita="GIALLO";

  const css=(priorita==="ROSSO")?"alert-red":
            (priorita==="ARANCIONE")?"alert-orange":
            (priorita==="GIALLO")?"alert-yellow":"alert-green";

  elementoSelezionato.classList.remove("alert-red","alert-orange","alert-yellow","alert-green");
  elementoSelezionato.classList.add(css);

  const chatId = buildChatId(scalaSel,pianoSel,latoSel,nominativo);

  db.collection("chat").doc(chatId).set({
    created: firebase.firestore.FieldValue.serverTimestamp()
  },{merge:true});

  db.collection("segnalazioni").add({
    scala: scalaSel,
    piano: pianoSel,
    lato: latoSel,
    nome: nominativo,
    temperatura: temp,
    descrizione: desc,
    tipo: tipo==="particomuni" ? "Parti comuni" : tipo,
    sottotipo: sotto,
    priorita,
    stato:"attiva",
    complesso: ["SCALA 6","SCALA 8","SCALA 10"].includes(scalaSel) ? "piobesi" : "guala",
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });

  chiudiConferma();
  chiudiModal();
}

/* SERVICE WORKER */
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("./service-worker.js");
}

/* PWA INSTALL */
let deferredPrompt;
const btnInstall=document.createElement("button");
btnInstall.id="installPWA";
btnInstall.innerText="ðŸ“² Installa App";
document.body.appendChild(btnInstall);
window.addEventListener("beforeinstallprompt",(e)=>{
  e.preventDefault();
  deferredPrompt=e;
  btnInstall.style.display="block";
});
btnInstall.addEventListener("click",async()=>{
  if(!deferredPrompt) return;
  btnInstall.style.display="none";
  deferredPrompt.prompt();
  deferredPrompt=null;
});
</script>

</body>
</html>
