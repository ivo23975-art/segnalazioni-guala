<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Segnalazioni Condominio Piazza Guala</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#cc0000">

<style>
/* ============================
   VARIABILI
============================ */
:root {
  --primary: #cc0000;
  --bg: #f3f4f6;
  --card-bg: #f7f7f7;
  --border: #cc0000;
  --shadow: 0 4px 14px rgba(0,0,0,0.12);
  --shadow-strong: 0 6px 22px rgba(204,0,0,0.45);

  --t-blue: #0077ff;
  --t-yellow: #ffcc00;
  --t-red: #d50000;
}

/* ============================
   BASE
============================ */
body {
  background: var(--bg);
  margin: 0;
  padding: 1rem;
  font-family: system-ui, sans-serif;
}

h1, h2 {
  text-align: center;
  margin: 0;
}

h1 { font-size: 1.7rem; font-weight: 800; margin-bottom: .2rem; }
h2 { font-size: 1.1rem; font-weight: 600; margin-bottom: 1.5rem; }

.container {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 1rem;
}
@media (max-width: 900px) {
  .container { grid-template-columns: 1fr; }
}

/* ============================
   SCALA
============================ */
.scalaBox {
  background: white;
  padding: 1rem;
  border-radius: 1rem;
  box-shadow: var(--shadow);
  max-height: 87vh;
  overflow-y: auto;
}

.scalaTitle {
  text-align: center;
  font-size: 1.4rem;
  font-weight: bold;
  margin-bottom: 1rem;
}

/* ============================
   BOX PIANO
============================ */
.pianoBox {
  background: #ffffff;
  border: 1px solid #e3e3e3;
  padding: 1rem;
  border-radius: .9rem;
  margin-bottom: 1rem;
  box-shadow: 0 2px 8px rgba(0,0,0,.07);
}

/* Riga piano + icone */
.pianoTop {
  font-weight: bold;
  margin-bottom: .8rem;
  font-size: 1rem;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

/* ============================
   ICONE CHAT (POS 1)
============================ */
.chatIconCard {
    font-size: 22px;
    cursor: pointer;
    margin-left: 10px;
    padding: 4px 10px;
    border-radius: 12px;
    font-weight: bold;
    color: white;
    transition: .2s;
    box-shadow: 0 0 10px #0004;
}

.chatIconCard:hover {
    transform: scale(1.12);
}

/* colori */
.chat-blue    { background:#0077ff; }
.chat-yellow  { background:#ffcc00; color:black; }
.chat-orange  { background:#ff8800; }
.chat-red     { background:#cc0000; animation:redBlink 1s infinite; }

/* lampi rossi */
@keyframes redBlink {
  0%,100%{background:#900;}
  50%{background:#ff2222;}
}

/* ============================
   CARD
============================ */
.cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: .6rem;
}

.card {
  position: relative;
  background: var(--card-bg);
  border: 2px solid var(--border);
  border-radius: 1rem;
  padding: .6rem;
  text-align: center;
  cursor: pointer;
  font-weight: bold;
  box-shadow: var(--shadow);
  transition: .15s ease;
}

.card:hover {
  transform: translateY(-3px);
  box-shadow: var(--shadow-strong);
}

/* temp */
.tempBox {
  font-size: .85rem;
  margin-top: 3px;
  display: flex;
  justify-content: center;
  gap: 4px;
  align-items: center;
}

.tempDot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
}

.t-blue { background: var(--t-blue); }
.t-yellow { background: var(--t-yellow); }
.t-red { background: var(--t-red); }

/* ============================
   POPUP CHAT (stile WhatsApp)
============================ */
.chat-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.70);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.chat-window {
  width: 380px;
  max-height: 80vh;
  background: #111;
  border-radius: 14px;
  padding: 15px;
  display: flex;
  flex-direction: column;
  box-shadow: 0 0 20px #00aaff80;
  border: 1px solid #00aaff55;
}

#chatTitle {
  color: #fff;
  text-align:center;
  margin-bottom:10px;
}

.chat-messages {
  flex: 1;
  background:#0f0f0f;
  border-radius:10px;
  padding:10px;
  overflow-y:auto;
}

.chat-bubble {
  max-width:80%;
  padding:8px 12px;
  border-radius:12px;
  margin-bottom:8px;
  font-size:0.9rem;
  display:flex;
  flex-direction:column;
}

.chat-user  { background:#1e3a5f; color:#b9d8ff; align-self:flex-start; }
.chat-admin { background:#145f32; color:#d6ffd6; align-self:flex-end; }

.bubble-time { font-size:0.75rem; opacity:.6; text-align:right; }

.chat-input {
  min-height:60px;
  background:#222;
  border:none;
  color:#fff;
  padding:10px;
  border-radius:8px;
  margin-top:8px;
}

.chat-buttons {
  display:flex;
  gap:10px;
  margin-top:10px;
}

.chat-send, .chat-close {
  flex:1;
  padding:10px;
  border:none;
  border-radius:8px;
  background:#0066ff;
  color:white;
  cursor:pointer;
}

/* sola lettura */
.chat-readonly {
  opacity: 0.5;
  pointer-events:none;
}
</style>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyAneaPGbeUWMNurMzGghrOoYpw4dsuIwr4",
  authDomain: "segnalazioni-guala.firebaseapp.com",
  projectId: "segnalazioni-guala",
  storageBucket: "segnalazioni-guala.firebasestorage.app",
  messagingSenderId: "118462666966",
  appId: "1:118462666966:web:9ca2cdb6985581fe79d177"
});
const db = firebase.firestore();
</script>
</head>

<body>

<h1>APP DEDICATA ALLE SEGNALAZIONI DEL CONDOMINIO</h1>
<h2>Piazza Guala â€¢ Via Piobesi</h2>

<div class="container"></div>

<!-- CHAT POPUP -->
<div id="chatPopup" class="chat-overlay">
  <div class="chat-window">

    <h2 id="chatTitle"></h2>

    <div id="chatMessages" class="chat-messages"></div>

    <textarea id="chatInput" class="chat-input"
              placeholder="Scrivi un messaggio..."></textarea>

    <div class="chat-buttons">
      <button id="btnSend" class="chat-send" onclick="sendChatMessageApp()">Invia</button>
      <button class="chat-close" onclick="closeChatApp()">Chiudi</button>
    </div>

  </div>
</div>

<script>
/* -----------------------------------------------------
   ID UTENTE UNICO AUTOMATICO:
   "SCALA-PIANO-LATO-NOME"
----------------------------------------------------- */
function genUserID(scala,piano,lato,nome){
    return `${scala}-${piano}-${lato}-${nome}`.replace(/\s+/g,"_");
}

/* -----------------------------------------------------
   LOGICA GENERAZIONE CARD + ICONA CHAT
----------------------------------------------------- */
const condominio = {
  "SCALA 131": { piani:{9:{dx:"BARBA / RIPANDELLI",sx:"BORDIGNON"},8:{dx:"BROCCARDO",sx:"ROMEO / VALENTINO"}} },
  "SCALA 131 BIS": { piani:{9:{dx:"ROETTI",sx:"COLPO / TOMASSO"}} },
  "SCALA 133": { piani:{9:{dx:"MONACO",sx:"P. MERLIN / C. RAPETTI"}} }
};

const container = document.querySelector(".container");

Object.keys(condominio).forEach(scala=>{
  const box = document.createElement("div");
  box.className="scalaBox";
  box.innerHTML=`<div class="scalaTitle">${scala}</div>`;

  const piani = condominio[scala].piani;

  Object.keys(piani).sort((a,b)=>b-a).forEach(piano=>{
      const dati = piani[piano];

      /* ICONA CHAT PER OGNI CARD */
      let pianoTopHTML = `
        <div class="pianoTop">
            ${piano}Â° piano
            <div>
              <span id="chatIcon-${genUserID(scala,piano,'DX',dati.dx)}"
                    class="chatIconCard chat-blue"
                    onclick="openChatFromCard('${scala}', '${piano}', 'DX', '${dati.dx}')">
                    ðŸ’¬
              </span>

              <span id="chatIcon-${genUserID(scala,piano,'SX',dati.sx)}"
                    class="chatIconCard chat-blue"
                    onclick="openChatFromCard('${scala}', '${piano}', 'SX', '${dati.sx}')">
                    ðŸ’¬
              </span>
            </div>
        </div>
      `;

      let html = `
        <div class="pianoBox">
          ${pianoTopHTML}
          <div class="cards">
            <div class="card"
                 onclick="openSegnalazione('${scala}','${piano}','DX','${dati.dx}', this)">
                ${dati.dx}
                <div class="tempBox">
                  <span class="tempDot t-blue"></span>
                  <span class="tempVal">â€”Â°C</span>
                </div>
            </div>

            <div class="card"
                 onclick="openSegnalazione('${scala}','${piano}','SX','${dati.sx}', this)">
                ${dati.sx}
                <div class="tempBox">
                  <span class="tempDot t-blue"></span>
                  <span class="tempVal">â€”Â°C</span>
                </div>
            </div>
          </div>
        </div>
      `;

      box.innerHTML += html;
  });

  container.appendChild(box);
});

/* -----------------------------------------------------
   CHAT LOGICHE COMPLETE
----------------------------------------------------- */

let currentChatUserID = null;
let unsubscribeChat = null;

/* -------- Apre chat da icona -------- */
function openChatFromCard(scala,piano,lato,nome){
    const idUser = genUserID(scala,piano,lato,nome);
    currentChatUserID = idUser;
    showChat();
}

/* -------- Mostra popup chat -------- */
function showChat(){
    document.getElementById("chatPopup").style.display="flex";
    document.getElementById("chatTitle").innerText = `Chat`;

    const box = document.getElementById("chatMessages");
    box.innerHTML = "";

    if(unsubscribeChat) unsubscribeChat();

    unsubscribeChat =
        db.collection("chat")
          .doc(currentChatUserID)
          .collection("msg")
          .orderBy("timestamp","asc")
          .onSnapshot(snap=>{
              box.innerHTML="";
              let count=0;

              snap.forEach(doc=>{
                const m = doc.data();
                renderChatMsg(m, box);
                if(m.mittente==="admin" && !m.letta) count++;
              });

              updateChatIconColor(currentChatUserID,count);

              box.scrollTop = box.scrollHeight;
          });

    markAsRead(currentChatUserID);
}

/* -------- Messaggi -------- */
function renderChatMsg(msg, box){
    const div = document.createElement("div");
    div.className = "chat-bubble " + (msg.mittente==="utente"?"chat-user":"chat-admin");

    const t = document.createElement("div");
    t.innerText = msg.testo;

    const time = document.createElement("div");
    time.className="bubble-time";

    if(msg.timestamp?.toDate)
      time.innerText = msg.timestamp.toDate().toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"});

    div.appendChild(t);
    div.appendChild(time);

    box.appendChild(div);
}

/* -------- Invia messaggio -------- */
function sendChatMessageApp(){
    const input = document.getElementById("chatInput");
    let txt = input.value.trim();
    if(!txt) return;

    db.collection("chat")
      .doc(currentChatUserID)
      .collection("msg")
      .add({
          testo: txt,
          mittente:"utente",
          letta:false,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });

    input.value="";
}

/* -------- Marca letti -------- */
function markAsRead(id){
    db.collection("chat")
      .doc(id)
      .collection("msg")
      .where("mittente","==","admin")
      .where("letta","==",false)
      .get()
      .then(q=>{
         q.forEach(doc=>{
            doc.ref.update({letta:true});
         });
      });
}

/* -------- Aggiorna colore icona -------- */
function updateChatIconColor(idUser, count){
    const icon = document.getElementById("chatIcon-"+idUser);
    if(!icon) return;

    icon.classList.remove("chat-blue","chat-yellow","chat-orange","chat-red");

    if(count===0) icon.classList.add("chat-blue");
    else if(count===1 || count===2) icon.classList.add("chat-yellow");
    else if(count===3) icon.classList.add("chat-orange");
    else if(count>=4) icon.classList.add("chat-red");
}

/* -------- Chiudi chat -------- */
function closeChatApp(){
    document.getElementById("chatPopup").style.display="none";
    if(unsubscribeChat) unsubscribeChat();
}
</script>

</body>
</html>
