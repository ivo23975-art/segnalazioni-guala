<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>SuperAdmin ‚Äì Gestione Chat e Segnalazioni</title>

    <link rel="stylesheet" href="dashboard.css">

    <!-- FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <!-- CONFIG -->
    <script src="firebase-config.js"></script>

    <!-- AUTH -->
    <script src="admin-auth.js"></script>

    <!-- DASHBOARD (NON TOCCATO) -->
    <script src="dashboard.js"></script>

    <style>
        .logout-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            background: #ff0000;
            color: #fff;
            padding: 10px 18px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        .section { margin-bottom: 35px; }

        .pin-ok { color:#00c853; font-weight:bold; }
        .pin-missing { color:#ff9800; font-weight:bold; }

        .btn-reset {
            background:#ff9800;
            padding:6px 10px;
            border-radius:5px;
            font-weight:bold;
            cursor:pointer;
        }

        .chat-preview {
            max-height:120px;
            overflow-y:auto;
            background:#0e1b2a;
            padding:8px;
            border-radius:6px;
            font-size:13px;
        }

        .msg-admin { color:#00e676; }
        .msg-user { color:#90caf9; }

        .chat-full {
            background:#081421;
            padding:10px;
            border-radius:8px;
            max-height:260px;
            overflow-y:auto;
        }

        .chat-input {
            width:100%;
            margin-top:6px;
            padding:6px;
            border-radius:6px;
        }
    </style>
</head>

<body>

<a class="logout-btn" onclick="adminLogout()">Logout</a>

<div class="header">SUPER ADMIN ‚Äì CHAT + RESET PIN</div>

<div class="content">

<!-- ===================================================
     SEZIONE CHAT + RESET PIN (IN TESTA)
=================================================== -->
<div class="section">
    <h2>üîê CHAT UTENTI</h2>

    <table class="table">
        <thead>
        <tr>
            <th>Scala</th>
            <th>Piano</th>
            <th>Lato</th>
            <th>Nome</th>
            <th>PIN</th>
            <th>Chat</th>
            <th>Azione</th>
        </tr>
        </thead>
        <tbody id="chatTable">
        <tr><td colspan="7">Caricamento‚Ä¶</td></tr>
        </tbody>
    </table>
</div>

<!-- ===================================================
     SEGNALAZIONI (LOGICA ORIGINALE)
=================================================== -->
<div class="section">
    <h2>üìã TUTTE LE SEGNALAZIONI</h2>

    <table class="table">
        <thead>
        <tr>
            <th>Data</th>
            <th>Scala</th>
            <th>Piano</th>
            <th>Lato</th>
            <th>Nome</th>
            <th>Temp</th>
            <th>Tipo</th>
            <th>Descrizione</th>
            <th>Azioni</th>
        </tr>
        </thead>
        <tbody id="tbody"></tbody>
    </table>
</div>

</div>

<script>
/* =============================
   ACCESSO
============================= */
requireRole("superadmin");

/* =============================
   SEGNALAZIONI (NON TOCCATE)
============================= */
loadSegnalazioni(r => true, true);

/* =============================
   CHAT SUPERADMIN + RESET PIN
============================= */
const chatTable = document.getElementById("chatTable");

db.collection("chats")
  .orderBy("meta.nome")
  .onSnapshot(snapshot => {

    chatTable.innerHTML = "";

    if (snapshot.empty) {
        chatTable.innerHTML = `<tr><td colspan="7">Nessuna chat</td></tr>`;
        return;
    }

    snapshot.forEach(doc => {
        const d = doc.data();
        const meta = d.meta || {};

        const pinOk = !!meta.pinHash;

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${meta.scala || "-"}</td>
            <td>${meta.piano || "-"}</td>
            <td>${meta.lato || "-"}</td>
            <td>${meta.nome || "-"}</td>
            <td class="${pinOk ? 'pin-ok' : 'pin-missing'}">
                ${pinOk ? "ATTIVO" : "DA IMPOSTARE"}
            </td>
            <td>
                <div class="chat-full" id="chat-${doc.id}">‚Ä¶</div>
                <input class="chat-input"
                       placeholder="Scrivi come admin‚Ä¶"
                       onkeydown="if(event.key==='Enter') sendAdminMsg('${doc.id}', this)">
            </td>
            <td>
                <span class="btn-reset"
                      onclick="resetPin('${doc.id}')">
                      RESET PIN
                </span>
            </td>
        `;
        chatTable.appendChild(tr);

        // realtime messaggi
        db.collection("chats")
          .doc(doc.id)
          .collection("messages")
          .orderBy("timestamp","asc")
          .onSnapshot(ms => {
              const box = document.getElementById("chat-"+doc.id);
              box.innerHTML = "";
              ms.forEach(m => {
                  const msg = m.data();
                  const div = document.createElement("div");
                  div.className = msg.mittente === "admin" ? "msg-admin" : "msg-user";
                  div.innerText = msg.testo;
                  box.appendChild(div);
              });
              box.scrollTop = box.scrollHeight;
          });
    });
});

/* =============================
   INVIO MESSAGGIO ADMIN
============================= */
function sendAdminMsg(chatId, input) {
    const text = input.value.trim();
    if (!text) return;

    db.collection("chats")
      .doc(chatId)
      .collection("messages")
      .add({
          testo: text,
          mittente: "admin",
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });

    input.value = "";
}

/* =============================
   RESET PIN REALE
============================= */
function resetPin(chatId) {
    if (!confirm("Resettare il PIN di questa chat?")) return;

    db.collection("chats")
      .doc(chatId)
      .update({
          "meta.pinHash": firebase.firestore.FieldValue.delete()
      })
      .then(() => alert("PIN resettato. L‚Äôutente dovr√† reimpostarlo."))
      .catch(err => alert("Errore reset PIN: " + err.message));
}
</script>

</body>
</html>
