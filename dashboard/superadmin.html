<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>SUPER ADMIN ‚Äì CHAT + RESET PIN</title>

<link rel="stylesheet" href="dashboard.css">

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<!-- CONFIG -->
<script src="firebase-config.js"></script>
<script src="admin-auth.js"></script>
<script src="dashboard.js"></script>

<style>
.logout-btn{
  position:absolute;top:15px;right:20px;
  background:#ff0000;color:#fff;
  padding:10px 18px;border-radius:6px;
  cursor:pointer;font-weight:bold;
}
.section{margin-bottom:30px;}
.chat-box{
  background:#0e1b2a;border-radius:8px;
  padding:8px;max-height:200px;
  overflow-y:auto;font-size:13px;
}
.chat-msg{margin-bottom:4px;}
.chat-user{color:#90caf9;}
.chat-admin{color:#00e676;}
.admin-input{
  width:100%;margin-top:6px;
  padding:6px;border-radius:4px;
}
.btn-send{
  margin-top:6px;
  background:#00e676;border:none;
  padding:6px 10px;border-radius:4px;
  cursor:pointer;font-weight:bold;
}
.btn-reset{
  background:#ff9800;
  padding:6px 10px;border-radius:4px;
  cursor:pointer;font-weight:bold;
}
.pin-ok{color:#00e676;font-weight:bold;}
.pin-missing{color:#ff9800;font-weight:bold;}
</style>
</head>

<body>

<a class="logout-btn" onclick="adminLogout()">Logout</a>

<div class="header">SUPER ADMIN ‚Äì CHAT + RESET PIN</div>

<div class="content">

<!-- ================= CHAT + RESET PIN ================= -->
<div class="section">
<h2>üîê CHAT UTENTI</h2>

<table class="table">
<thead>
<tr>
<th>Scala</th>
<th>Piano</th>
<th>Lato</th>
<th>Nome</th>
<th>PIN</th>
<th>Chat</th>
<th>Azione</th>
</tr>
</thead>
<tbody id="chatTable">
<tr><td colspan="7">Caricamento‚Ä¶</td></tr>
</tbody>
</table>
</div>

<!-- ================= SEGNALAZIONI (INVARIATE) ================= -->
<div class="section">
<h2>üìã TUTTE LE SEGNALAZIONI</h2>

<table class="table">
<thead>
<tr>
<th>Data</th>
<th>Scala</th>
<th>Piano</th>
<th>Lato</th>
<th>Nome</th>
<th>Temp</th>
<th>Tipo</th>
<th>Descrizione</th>
<th>Azioni</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

</div>

<script>
requireRole("superadmin");
loadSegnalazioni(r=>true,true);

const chatTable=document.getElementById("chatTable");

firebase.firestore().collection("chats").onSnapshot(snap=>{
  chatTable.innerHTML="";
  if(snap.empty){
    chatTable.innerHTML="<tr><td colspan='7'>Nessuna chat</td></tr>";
    return;
  }

  snap.forEach(doc=>{
    const d=doc.data().meta||{};
    const chatId=doc.id;

    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${d.scala||""}</td>
      <td>${d.piano||""}</td>
      <td>${d.lato||""}</td>
      <td>${d.nome||""}</td>
      <td class="${d.pinHash?'pin-ok':'pin-missing'}">
        ${d.pinHash?'ATTIVO':'NON SET'}
      </td>
      <td>
        <div class="chat-box" id="box-${chatId}">‚Ä¶</div>
        <textarea class="admin-input" id="input-${chatId}" placeholder="Scrivi come admin..."></textarea>
        <button class="btn-send" onclick="sendAdmin('${chatId}')">Invia</button>
      </td>
      <td>
        <span class="btn-reset" onclick="resetPin('${chatId}')">RESET PIN</span>
      </td>
    `;
    chatTable.appendChild(tr);

    firebase.firestore()
      .collection("chats")
      .doc(chatId)
      .collection("messages")
      .orderBy("timestamp","asc")
      .onSnapshot(ms=>{
        const box=document.getElementById("box-"+chatId);
        box.innerHTML="";
        ms.forEach(m=>{
          const msg=m.data();
          const div=document.createElement("div");
          div.className="chat-msg "+(msg.mittente==="admin"?"chat-admin":"chat-user");
          div.innerText=msg.testo;
          box.appendChild(div);
        });
        box.scrollTop=box.scrollHeight;
      });
  });
});

function sendAdmin(chatId){
  const input=document.getElementById("input-"+chatId);
  const text=input.value.trim();
  if(!text)return;

  firebase.firestore()
    .collection("chats")
    .doc(chatId)
    .collection("messages")
    .add({
      testo:text,
      mittente:"admin",
      timestamp:firebase.firestore.FieldValue.serverTimestamp()
    });
  input.value="";
}

function resetPin(chatId){
  if(!confirm("Resettare il PIN?"))return;
  firebase.firestore()
    .collection("chats")
    .doc(chatId)
    .update({
      "meta.pinHash":firebase.firestore.FieldValue.delete()
    });
}
</script>

</body>
</html>
