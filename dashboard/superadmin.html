<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>SUPER ADMIN v2 â€“ Chat + Segnalazioni</title>

<link rel="stylesheet" href="dashboard.css">

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<!-- CONFIG -->
<script src="firebase-config.js"></script>
<script src="admin-auth.js"></script>
<script src="dashboard.js"></script>

<style>
.logout-btn{
  position:absolute;top:15px;right:20px;
  background:#ff0000;color:#fff;
  padding:10px 18px;border-radius:6px;
  cursor:pointer;font-weight:bold
}
.section{margin-bottom:30px}

.chat-toggle{
  background:#0f2a3d;
  padding:12px;
  border-radius:8px;
  margin-bottom:6px;
  cursor:pointer;
  font-weight:bold;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.chat-toggle span{
  opacity:.8;
}
.chat-toggle.active{
  background:#123e5c;
}

.chat-body{
  display:none;
  background:#0e1b2a;
  border-radius:8px;
  padding:10px;
  margin-bottom:12px;
}

.chat-box{
  max-height:180px;
  overflow-y:auto;
  margin-bottom:6px;
}
.chat-msg{margin-bottom:6px;font-size:14px}
.chat-user{color:#90caf9}
.chat-admin{color:#00e676}

textarea{
  width:100%;
  height:60px;
  border-radius:6px;
  padding:6px;
}

.btn{
  padding:6px 10px;
  border-radius:4px;
  font-weight:bold;
  cursor:pointer;
  margin-right:4px;
}
.btn-send{background:#00c853;color:#000}
.btn-reset{background:#ff9800;color:#000}
.btn-archive{background:#607d8b;color:#fff}
.btn-clear{background:#d50000;color:#fff}

.status-active{color:#00e676;font-weight:bold}
.status-archived{color:#ff9800;font-weight:bold}
</style>
</head>

<body>

<a class="logout-btn" onclick="adminLogout()">Logout</a>

<div class="header">SUPER ADMIN v2 â€“ CHAT + SEGNALAZIONI</div>

<div class="content">

<!-- ================= CHAT ================= -->
<div class="section">
<h2>ðŸ’¬ CHAT UTENTI</h2>
<div id="chatContainer">Caricamentoâ€¦</div>
</div>

<!-- ================= SEGNALAZIONI ================= -->
<div class="section">
<h2>ðŸ“‹ TUTTE LE SEGNALAZIONI</h2>
<table class="table">
<thead>
<tr>
<th>Data</th><th>Scala</th><th>Piano</th><th>Lato</th>
<th>Nome</th><th>Temp</th><th>Tipo</th><th>Descrizione</th><th>Az.</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

</div>

<script>
requireRole("superadmin");
loadSegnalazioni(r=>true,true);

const chatContainer = document.getElementById("chatContainer");
let openChatId = null;

firebase.firestore().collection("chats")
.orderBy("meta.nome")
.onSnapshot(snap=>{
  chatContainer.innerHTML="";
  if(snap.empty){
    chatContainer.innerText="Nessuna chat";
    return;
  }

  snap.forEach(doc=>{
    const d = doc.data();
    const m = d.meta || {};
    const archived = m.archived === true;

    const wrap = document.createElement("div");

    const header = document.createElement("div");
    header.className = "chat-toggle";
    header.innerHTML = `
      <div>${m.nome || ""} â€“ ${m.scala || ""} ${m.piano || ""} ${m.lato || ""}</div>
      <span>${archived ? "ARCHIVIATA" : "ATTIVA"} â–¸</span>
    `;

    const body = document.createElement("div");
    body.className = "chat-body";
    body.id = "body-" + doc.id;

    body.innerHTML = `
      <div class="chat-box" id="box-${doc.id}"></div>
      <textarea id="input-${doc.id}" placeholder="Scrivi come admin..."></textarea>
      <div style="margin-top:6px">
        <button class="btn btn-send" onclick="sendAdmin('${doc.id}')">INVIA</button>
        <button class="btn btn-reset" onclick="resetPin('${doc.id}')">RESET PIN</button>
        <button class="btn btn-archive" onclick="toggleArchive('${doc.id}',${archived})">
          ${archived?"RIPRISTINA":"ARCHIVIA"}
        </button>
        <button class="btn btn-clear" onclick="clearChat('${doc.id}')">CANCELLA TESTI</button>
      </div>
    `;

    header.onclick = ()=>{
      document.querySelectorAll(".chat-body").forEach(el=>el.style.display="none");
      document.querySelectorAll(".chat-toggle").forEach(el=>el.classList.remove("active"));

      if(openChatId !== doc.id){
        body.style.display="block";
        header.classList.add("active");
        openChatId = doc.id;
      }else{
        openChatId = null;
      }
    };

    wrap.appendChild(header);
    wrap.appendChild(body);
    chatContainer.appendChild(wrap);

    firebase.firestore().collection("chats")
      .doc(doc.id).collection("messages")
      .orderBy("timestamp","asc")
      .onSnapshot(ms=>{
        const box=document.getElementById("box-"+doc.id);
        if(!box) return;
        box.innerHTML="";
        ms.forEach(m=>{
          const msg=m.data();
          const div=document.createElement("div");
          div.className="chat-msg "+(msg.mittente==="admin"?"chat-admin":"chat-user");
          div.innerText=msg.testo;
          box.appendChild(div);
        });
        box.scrollTop=box.scrollHeight;
      });
  });
});

function sendAdmin(id){
  const input=document.getElementById("input-"+id);
  const txt=input.value.trim();
  if(!txt)return;
  firebase.firestore().collection("chats")
    .doc(id).collection("messages")
    .add({
      testo:txt,
      mittente:"admin",
      timestamp:firebase.firestore.FieldValue.serverTimestamp()
    });
  input.value="";
}

function resetPin(id){
  if(!confirm("Reset PIN utente?"))return;
  firebase.firestore().collection("chats")
    .doc(id)
    .update({ "meta.pinHash": null });
}

function toggleArchive(id,archived){
  firebase.firestore().collection("chats")
    .doc(id)
    .update({ "meta.archived": !archived });
}

function clearChat(id){
  if(!confirm("Cancellare SOLO i messaggi?"))return;
  firebase.firestore().collection("chats")
    .doc(id).collection("messages")
    .get()
    .then(snap=>snap.forEach(d=>d.ref.delete()));
}
</script>

</body>
</html>
