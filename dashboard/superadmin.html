<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>SUPER ADMIN â€“ Chat + Reset PIN</title>

<link rel="stylesheet" href="dashboard.css">

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script src="firebase-config.js"></script>
<script src="admin-auth.js"></script>
<script src="dashboard.js"></script>

<style>
.logout-btn{
  position:absolute;top:15px;right:20px;
  background:#ff0000;color:#fff;
  padding:10px 18px;border-radius:6px;
  cursor:pointer;font-weight:bold
}
.section{margin-bottom:40px}
.chat-box{
  background:#0e1b2a;border-radius:8px;
  padding:8px;max-height:180px;overflow-y:auto
}
.chat-msg{font-size:13px;margin-bottom:4px}
.chat-user{color:#90caf9}
.chat-admin{color:#00e676}
.chat-input{
  width:100%;margin-top:6px;
  padding:6px;border-radius:4px;
  border:none
}
.btn{
  padding:6px 10px;border-radius:4px;
  cursor:pointer;font-weight:bold
}
.btn-reset{background:#ff9800}
.btn-archive{background:#03a9f4}
.btn-delete{background:#e53935;color:#fff}
.pin-ok{color:#00c853;font-weight:bold}
.pin-missing{color:#ff9800;font-weight:bold}
</style>
</head>

<body>

<a class="logout-btn" onclick="adminLogout()">Logout</a>

<div class="header">SUPER ADMIN â€“ CHAT + RESET PIN</div>

<div class="content">

<!-- ================= CHAT ================= -->
<div class="section">
<h2>ðŸ’¬ CHAT UTENTI</h2>

<table class="table">
<thead>
<tr>
  <th>Complesso</th>
  <th>Scala</th>
  <th>Piano</th>
  <th>Lato</th>
  <th>Nome</th>
  <th>PIN</th>
  <th>Chat</th>
  <th>Azioni</th>
</tr>
</thead>
<tbody id="chatTable">
<tr><td colspan="8">Caricamentoâ€¦</td></tr>
</tbody>
</table>
</div>

<!-- ================= SEGNALAZIONI ================= -->
<div class="section">
<h2>ðŸ“‹ TUTTE LE SEGNALAZIONI</h2>

<table class="table">
<thead>
<tr>
<th>Data</th><th>Scala</th><th>Piano</th><th>Lato</th>
<th>Nome</th><th>Temp</th><th>Tipo</th><th>Descrizione</th><th>Azioni</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

</div>

<script>
requireRole("superadmin");

/* LOGICA SEGNAZIONI INVARIATA */
loadSegnalazioni(r=>true,true);

/* ================= CHAT ================= */
const chatTable = document.getElementById("chatTable");

firebase.firestore()
.collection("chats")
.where("meta.archived","!=",true)
.onSnapshot(snap=>{
  chatTable.innerHTML="";
  if(snap.empty){
    chatTable.innerHTML="<tr><td colspan='8'>Nessuna chat</td></tr>";
    return;
  }

  snap.forEach(doc=>{
    const d = doc.data().meta;
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${d.complesso}</td>
      <td>${d.scala}</td>
      <td>${d.piano}</td>
      <td>${d.lato}</td>
      <td>${d.nome}</td>
      <td class="${d.pinHash?'pin-ok':'pin-missing'}">
        ${d.pinHash?'ATTIVO':'RESET'}
      </td>
      <td>
        <div class="chat-box" id="box-${doc.id}"></div>
        <input class="chat-input" id="input-${doc.id}" placeholder="Scrivi come admin..."
          onkeydown="if(event.key==='Enter')sendAdminMsg('${doc.id}')">
      </td>
      <td>
        <div class="btn btn-reset" onclick="resetPin('${doc.id}')">RESET PIN</div><br><br>
        <div class="btn btn-archive" onclick="archiveChat('${doc.id}')">ARCHIVIA</div><br><br>
        <div class="btn btn-delete" onclick="deleteChat('${doc.id}')">CANCELLA</div>
      </td>
    `;
    chatTable.appendChild(tr);

    firebase.firestore()
    .collection("chats").doc(doc.id)
    .collection("messages")
    .orderBy("timestamp")
    .limit(20)
    .onSnapshot(ms=>{
      const box=document.getElementById("box-"+doc.id);
      box.innerHTML="";
      ms.forEach(m=>{
        const x=m.data();
        const div=document.createElement("div");
        div.className="chat-msg "+(x.mittente==="admin"?"chat-admin":"chat-user");
        div.innerText=x.testo;
        box.appendChild(div);
      });
      box.scrollTop=box.scrollHeight;
    });
  });
});

/* ===== FUNZIONI ===== */

function sendAdminMsg(id){
  const input=document.getElementById("input-"+id);
  const txt=input.value.trim();
  if(!txt)return;

  firebase.firestore()
  .collection("chats").doc(id)
  .collection("messages")
  .add({
    testo:txt,
    mittente:"admin",
    timestamp:firebase.firestore.FieldValue.serverTimestamp()
  });

  input.value="";
}

function resetPin(id){
  if(!confirm("Reset PIN chat?"))return;
  firebase.firestore().collection("chats").doc(id)
  .update({ "meta.pinHash": firebase.firestore.FieldValue.delete() });
}

function archiveChat(id){
  if(!confirm("Archiviare la chat?"))return;
  firebase.firestore().collection("chats").doc(id)
  .update({ "meta.archived": true });
}

async function deleteChat(id){
  if(!confirm("CANCELLA DEFINITIVAMENTE la chat?"))return;

  const ref=firebase.firestore().collection("chats").doc(id);
  const msgs=await ref.collection("messages").get();
  msgs.forEach(m=>m.ref.delete());
  await ref.delete();
}
</script>

</body>
</html>
