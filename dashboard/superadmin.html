<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>SuperAdmin â€“ Segnalazioni & Chat</title>

<link rel="stylesheet" href="dashboard.css">

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script src="firebase-config.js"></script>
<script src="admin-auth.js"></script>
<script src="dashboard.js"></script>

<style>
.logout-btn{
    position:absolute;top:15px;right:20px;
    background:#ff0000;color:#fff;
    padding:10px 18px;border-radius:6px;
    cursor:pointer;font-weight:bold
}
.section{margin-bottom:40px}
.chat-box{
    background:#0e1b2a;
    border-radius:8px;
    padding:8px;
    max-height:180px;
    overflow-y:auto;
    font-size:14px
}
.chat-user{color:#90caf9}
.chat-admin{color:#00e676}
.chat-input{
    width:100%;
    padding:6px;
    margin-top:6px;
    border-radius:6px;
    border:none
}
.btn{
    padding:6px 10px;
    border-radius:4px;
    cursor:pointer;
    font-weight:bold;
    border:none
}
.btn-send{background:#00e676}
.btn-reset{background:#ff9800}
.btn-archive{background:#607d8b;color:#fff}
.btn-delete{background:#b00000;color:#fff}
</style>
</head>

<body>

<a class="logout-btn" onclick="adminLogout()">Logout</a>

<div class="header">SUPER ADMIN</div>
<div class="content">

<!-- ================= CHAT ================= -->
<div class="section">
<h2>ðŸ’¬ CHAT UTENTI</h2>

<table class="table">
<thead>
<tr>
<th>Complesso</th>
<th>Scala</th>
<th>Piano</th>
<th>Lato</th>
<th>Nome</th>
<th>Chat</th>
<th>Azioni</th>
</tr>
</thead>
<tbody id="chatTable"></tbody>
</table>
</div>

<!-- ================= SEGNALAZIONI ================= -->
<div class="section">
<h2>ðŸ“‹ TUTTE LE SEGNALAZIONI</h2>
<table class="table">
<thead>
<tr>
<th>Data</th><th>Scala</th><th>Piano</th><th>Lato</th>
<th>Nome</th><th>Temp</th><th>Tipo</th><th>Descrizione</th><th>Azioni</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

</div>

<script>
requireRole("superadmin");

/* SEGNALAZIONI â€“ INTACT */
loadSegnalazioni(r=>true,true);

/* ================= CHAT ================= */
const chatTable=document.getElementById("chatTable");

firebase.firestore()
.collection("chats")
.orderBy("meta.createdAt","desc")
.onSnapshot(snap=>{
    chatTable.innerHTML="";
    if(snap.empty){
        chatTable.innerHTML="<tr><td colspan='7'>Nessuna chat</td></tr>";
        return;
    }

    snap.forEach(doc=>{
        const c=doc.data();
        if(c.meta?.archived) return;

        const tr=document.createElement("tr");
        tr.innerHTML=`
<td>${c.meta.complesso}</td>
<td>${c.meta.scala}</td>
<td>${c.meta.piano}</td>
<td>${c.meta.lato}</td>
<td>${c.meta.nome}</td>
<td>
<div class="chat-box" id="box-${doc.id}"></div>
<textarea class="chat-input" id="inp-${doc.id}" placeholder="Rispondiâ€¦"></textarea>
<button class="btn btn-send" onclick="sendAdminMsg('${doc.id}')">INVIA</button>
</td>
<td>
<button class="btn btn-reset" onclick="resetPin('${doc.id}')">RESET PIN</button><br><br>
<button class="btn btn-archive" onclick="archiveChat('${doc.id}')">ARCHIVIA</button><br><br>
<button class="btn btn-delete" onclick="deleteChat('${doc.id}')">CANCELLA</button>
</td>`;
        chatTable.appendChild(tr);

        firebase.firestore()
        .collection("chats").doc(doc.id)
        .collection("messages")
        .orderBy("timestamp","asc")
        .limit(10)
        .onSnapshot(ms=>{
            const box=document.getElementById("box-"+doc.id);
            box.innerHTML="";
            ms.forEach(m=>{
                const d=m.data();
                const div=document.createElement("div");
                div.className=d.mittente==="admin"?"chat-admin":"chat-user";
                div.innerText=d.testo;
                box.appendChild(div);
            });
            box.scrollTop=box.scrollHeight;
        });
    });
});

function sendAdminMsg(id){
    const input=document.getElementById("inp-"+id);
    const text=input.value.trim();
    if(!text) return;
    firebase.firestore()
    .collection("chats").doc(id)
    .collection("messages")
    .add({
        testo:text,
        mittente:"admin",
        timestamp:firebase.firestore.FieldValue.serverTimestamp()
    });
    input.value="";
}

function resetPin(id){
    if(!confirm("Resettare PIN?"))return;
    firebase.firestore()
    .collection("chats").doc(id)
    .update({ "meta.pinHash": firebase.firestore.FieldValue.delete() });
}

function archiveChat(id){
    if(!confirm("Archiviare chat?"))return;
    firebase.firestore()
    .collection("chats").doc(id)
    .update({ "meta.archived": true });
}

function deleteChat(id){
    if(!confirm("CANCELLA DEFINITIVAMENTE?"))return;
    firebase.firestore().collection("chats").doc(id).delete();
}
</script>

</body>
</html>
