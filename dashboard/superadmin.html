<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>SuperAdmin â€“ Chat & Segnalazioni</title>

<link rel="stylesheet" href="dashboard.css">

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="firebase-config.js"></script>
<script src="admin-auth.js"></script>
<script src="dashboard.js"></script>

<style>
.logout-btn{position:absolute;top:15px;right:20px;background:#c00;color:#fff;padding:10px;border-radius:6px;font-weight:bold}
.chat-box{background:#0e1b2a;border-radius:8px;padding:8px;max-height:180px;overflow-y:auto;font-size:14px}
.chat-user{color:#90caf9}
.chat-admin{color:#00e676}
textarea{width:100%;margin-top:6px;border-radius:6px}
.btn{padding:6px 10px;border:none;border-radius:4px;font-weight:bold;cursor:pointer}
.btn-send{background:#00e676}
.btn-reset{background:#ff9800}
.btn-clear{background:#607d8b;color:#fff}
.btn-archive{background:#000;color:#fff}
.disabled{opacity:.4;pointer-events:none}
</style>
</head>

<body>

<a class="logout-btn" onclick="adminLogout()">Logout</a>
<div class="header">SUPER ADMIN</div>
<div class="content">

<h2>ðŸ’¬ CHAT UTENTI</h2>
<table class="table">
<thead>
<tr>
<th>Complesso</th><th>Scala</th><th>Piano</th><th>Lato</th><th>Nome</th>
<th>Chat</th><th>Azioni</th>
</tr>
</thead>
<tbody id="chatTable"></tbody>
</table>

<h2>ðŸ“‹ SEGNALAZIONI</h2>
<table class="table">
<thead>
<tr><th>Data</th><th>Scala</th><th>Piano</th><th>Lato</th><th>Nome</th><th>Temp</th><th>Tipo</th><th>Descrizione</th><th>Azioni</th></tr>
</thead>
<tbody id="tbody"></tbody>
</table>

</div>

<script>
requireRole("superadmin");
loadSegnalazioni(r=>true,true);

const chatTable=document.getElementById("chatTable");

firebase.firestore().collection("chats")
.orderBy("meta.createdAt","desc")
.onSnapshot(snap=>{
 chatTable.innerHTML="";
 snap.forEach(doc=>{
  const c=doc.data();
  const archived=c.meta.archived===true;
  const tr=document.createElement("tr");

  tr.innerHTML=`
<td>${c.meta.complesso}</td>
<td>${c.meta.scala}</td>
<td>${c.meta.piano}</td>
<td>${c.meta.lato}</td>
<td>${c.meta.nome}</td>

<td>
<div class="chat-box" id="box-${doc.id}"></div>
<textarea id="inp-${doc.id}" ${archived?"disabled":""}></textarea>
<button class="btn btn-send ${archived?"disabled":""}" onclick="sendMsg('${doc.id}')">INVIA</button>
</td>

<td>
<button class="btn btn-reset" onclick="resetPin('${doc.id}')">RESET PIN</button><br><br>
<button class="btn btn-clear" onclick="clearChat('${doc.id}')">SVUOTA</button><br><br>
<button class="btn btn-archive" onclick="archiveChat('${doc.id}')">ARCHIVIA</button>
</td>
`;
  chatTable.appendChild(tr);

  if(archived) return;

  firebase.firestore().collection("chats").doc(doc.id)
  .collection("messages").orderBy("timestamp","asc")
  .onSnapshot(ms=>{
   const box=document.getElementById("box-"+doc.id);
   box.innerHTML="";
   ms.forEach(m=>{
    const d=m.data();
    const div=document.createElement("div");
    div.className=d.mittente==="admin"?"chat-admin":"chat-user";
    div.innerText=d.testo;
    box.appendChild(div);
   });
   box.scrollTop=box.scrollHeight;
  });
 });
});

function sendMsg(id){
 const t=document.getElementById("inp-"+id);
 if(!t.value.trim())return;
 firebase.firestore().collection("chats").doc(id)
 .collection("messages").add({
  testo:t.value,
  mittente:"admin",
  timestamp:firebase.firestore.FieldValue.serverTimestamp()
 });
 t.value="";
}

function resetPin(id){
 if(!confirm("Reset PIN?"))return;
 firebase.firestore().collection("chats").doc(id)
 .update({ "meta.pinHash": firebase.firestore.FieldValue.delete() });
}

function clearChat(id){
 if(!confirm("Svuotare SOLO i messaggi?"))return;
 firebase.firestore().collection("chats").doc(id)
 .collection("messages").get()
 .then(snap=>snap.forEach(d=>d.ref.delete()));
}

function archiveChat(id){
 if(!confirm("Archiviare chat?"))return;
 firebase.firestore().collection("chats").doc(id)
 .update({ "meta.archived": true, "meta.blocked": true });
}
</script>

</body>
</html>
