<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SuperAdmin – Tutte le Segnalazioni</title>

    <link rel="stylesheet" href="dashboard.css">

    <!-- FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <!-- CONFIG FIREBASE -->
    <script src="firebase-config.js"></script>

    <!-- LOGIN + RUOLI -->
    <script src="admin-auth.js"></script>

    <!-- LOGICA DASHBOARD -->
    <script src="dashboard.js"></script>

    <style>
        .logout-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            background: #ff0000;
            color: white;
            padding: 10px 18px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none;
            transition: 0.2s;
        }
        .logout-btn:hover {
            background: #cc0000;
        }
    </style>
</head>

<body>

<a class="logout-btn" onclick="adminLogout()">Logout</a>

<div class="header">SUPER ADMIN – TUTTE LE SEGNALAZIONI</div>

<div class="content">

    <!-- ======================================================
         PRIORITÀ: RESET PIN (DEVE STARE IN CIMA)
         (questa sezione viene ri-posizionata automaticamente
          anche se dashboard.js la genera più in basso)
    ======================================================= -->
    <div id="pinResetTopAnchor"></div>

    <table class="table">
        <thead>
        <tr>
            <th>Data</th>
            <th>Scala</th>
            <th>Piano</th>
            <th>Lato</th>
            <th>Nome</th>
            <th>Temp</th>
            <th>Tipo</th>
            <th>Descrizione</th>
            <th>Azioni</th>
        </tr>
        </thead>

        <tbody id="tbody"></tbody>
    </table>

</div>

<script>
console.log("[DEBUG] SuperAdmin – pannello avviato");

/* Protezione accesso */
requireRole("superadmin");

/* Nessun filtro: il SuperAdmin vede tutto e può ELIMINARE */
loadSegnalazioni(
    r => true,   // mostra tutte le segnalazioni
    true         // abilita il pulsante elimina
);

/* ======================================================
   SPOSTA "Chat utenti – Reset PIN" IN CIMA (PRIORITÀ)
   - NON cambia logiche, non tocca segnalazioni.
   - Riordina solo il DOM: la sezione reset viene portata
     sopra la tabella segnalazioni.
====================================================== */
(function pinResetMoveToTop() {
    const anchor = document.getElementById("pinResetTopAnchor");
    if (!anchor) return;

    let done = false;

    function findResetSectionRoot() {
        // Cerchiamo un titolo che contenga "Chat utenti – Reset PIN"
        const all = Array.from(document.querySelectorAll("h1,h2,h3,h4,div,span"));
        const titleEl = all.find(el => {
            const t = (el.textContent || "").trim();
            return t.toLowerCase().includes("chat utenti") && t.toLowerCase().includes("reset");
        });

        if (!titleEl) return null;

        // Se dashboard.js crea una sezione intera, in genere il titolo è dentro un contenitore.
        // Proviamo a risalire a un blocco "ragionevole" (div/section) che contenga anche una tabella.
        let root = titleEl;
        for (let i = 0; i < 6; i++) {
            if (!root || !root.parentElement) break;
            const p = root.parentElement;
            const hasTable = !!p.querySelector("table");
            const hasButtons = !!p.querySelector("button");
            if (hasTable || hasButtons) root = p;
            else root = p;
        }

        // Se possibile, risaliamo fino a un contenitore che contenga il titolo e la tabella reset
        // ma senza inglobare l'intera pagina.
        let candidate = titleEl.closest("div,section") || titleEl.parentElement;
        if (!candidate) candidate = root;

        // Se dentro il candidate non c'è alcuna tabella, allarghiamo al parent (massimo 3 livelli)
        for (let j = 0; j < 3; j++) {
            if (!candidate) break;
            if (candidate.querySelector && candidate.querySelector("table")) break;
            candidate = candidate.parentElement;
        }

        return candidate;
    }

    function moveIfFound() {
        if (done) return;

        const resetRoot = findResetSectionRoot();
        if (!resetRoot) return;

        // Evita di spostare l'intero body o contenitori enormi
        if (resetRoot === document.body || resetRoot === document.documentElement) return;

        // Se è già sopra (prima dell'anchor), non fare nulla
        if (resetRoot.previousElementSibling === anchor) {
            done = true;
            return;
        }

        // Sposta immediatamente sopra la tabella segnalazioni (cioè sull'anchor)
        anchor.insertAdjacentElement("afterend", resetRoot);
        done = true;

        console.log("[DEBUG] Reset PIN: sezione portata in cima.");
    }

    // Tentativi immediati + observer (dashboard.js potrebbe renderizzare dopo)
    document.addEventListener("DOMContentLoaded", () => {
        moveIfFound();

        const obs = new MutationObserver(() => {
            moveIfFound();
            if (done) obs.disconnect();
        });

        obs.observe(document.body, { childList: true, subtree: true });

        // Backup: retry temporizzati
        setTimeout(moveIfFound, 300);
        setTimeout(moveIfFound, 800);
        setTimeout(moveIfFound, 1500);
        setTimeout(() => {
            moveIfFound();
            if (done) obs.disconnect();
        }, 2500);
    });
})();
</script>

</body>
</html>
