<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>SUPER ADMIN â€“ Chat + Segnalazioni</title>

<link rel="stylesheet" href="dashboard.css">

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<!-- CONFIG -->
<script src="firebase-config.js"></script>
<script src="admin-auth.js"></script>
<script src="dashboard.js"></script>

<style>
.logout-btn{
  position:absolute;top:15px;right:20px;
  background:#ff0000;color:#fff;
  padding:10px 18px;border-radius:6px;
  cursor:pointer;font-weight:bold
}
.section{margin-bottom:30px}

.chat-list{margin-bottom:20px}
.chat-item{
  background:#0f2a3d;
  padding:10px;
  border-radius:6px;
  margin-bottom:6px;
  cursor:pointer;
}
.chat-item.active{background:#123e5c}

.chat-body{
  background:#0e1b2a;
  border-radius:8px;
  padding:10px;
}

.chat-box{
  max-height:200px;
  overflow-y:auto;
  margin-bottom:6px;
}
.chat-msg{margin-bottom:6px;font-size:14px}
.chat-user{color:#90caf9}
.chat-admin{color:#00e676}

textarea{
  width:100%;
  height:60px;
  border-radius:6px;
  padding:6px;
}

.btn{
  padding:6px 10px;
  border-radius:4px;
  font-weight:bold;
  cursor:pointer;
  margin-right:4px;
}
.btn-send{background:#00c853;color:#000}
</style>
</head>

<body>

<a class="logout-btn" onclick="adminLogout()">Logout</a>

<div class="header">SUPER ADMIN â€“ CHAT + SEGNALAZIONI</div>

<div class="content">

<!-- ================= CHAT ================= -->
<div class="section">
<h2>ðŸ’¬ CHAT UTENTI</h2>

<div id="chatList" class="chat-list">Caricamentoâ€¦</div>

<div id="chatBody" class="chat-body" style="display:none">
  <div id="chatBox" class="chat-box"></div>
  <textarea id="chatInput" placeholder="Scrivi come admin..."></textarea>
  <div style="margin-top:6px">
    <button class="btn btn-send" onclick="sendAdmin()">INVIA</button>
  </div>
</div>

</div>

<!-- ================= SEGNALAZIONI ================= -->
<div class="section">
<h2>ðŸ“‹ TUTTE LE SEGNALAZIONI</h2>
<table class="table">
<thead>
<tr>
<th>Data</th><th>Scala</th><th>Piano</th><th>Lato</th>
<th>Nome</th><th>Temp</th><th>Tipo</th><th>Descrizione</th><th>Az.</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

</div>

<script>
requireRole("superadmin");
loadSegnalazioni(r=>true,true);

/* =====================
   CHAT â€“ FASE 1 BONIFICA
===================== */

const chatList = document.getElementById("chatList");
const chatBody = document.getElementById("chatBody");
const chatBox  = document.getElementById("chatBox");
const chatInput = document.getElementById("chatInput");

let currentChatId = null;
let unsubscribeMessages = null;

/* LISTA CHAT â€“ SOLO META */
firebase.firestore().collection("chats")
.onSnapshot(snap=>{
  chatList.innerHTML = "";
  if(snap.empty){
    chatList.innerText = "Nessuna chat";
    return;
  }

  snap.forEach(doc=>{
    const m = (doc.data().meta) || {};
    const item = document.createElement("div");
    item.className = "chat-item";
    item.innerText = `${m.nome || ""} â€“ ${m.scala || ""} ${m.piano || ""} ${m.lato || ""}`;

    item.onclick = () => openChat(doc.id, item);
    chatList.appendChild(item);
  });
});

/* APERTURA CHAT â€“ UN SOLO LISTENER */
function openChat(chatId, element){
  if(currentChatId === chatId) return;

  // reset UI
  document.querySelectorAll(".chat-item").forEach(i=>i.classList.remove("active"));
  element.classList.add("active");

  chatBox.innerHTML = "";
  chatBody.style.display = "block";

  // chiudi listener precedente
  if(unsubscribeMessages){
    unsubscribeMessages();
    unsubscribeMessages = null;
  }

  currentChatId = chatId;

  unsubscribeMessages = firebase.firestore()
    .collection("chats")
    .doc(chatId)
    .collection("messages")
    .orderBy("timestamp","asc")
    .onSnapshot(snap=>{
      chatBox.innerHTML = "";
      snap.forEach(d=>{
        const msg = d.data();
        const div = document.createElement("div");
        div.className = "chat-msg " + (msg.mittente === "admin" ? "chat-admin" : "chat-user");
        div.innerText = msg.testo;
        chatBox.appendChild(div);
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    });
}

/* INVIO MESSAGGIO ADMIN */
function sendAdmin(){
  if(!currentChatId) return;
  const txt = chatInput.value.trim();
  if(!txt) return;

  firebase.firestore()
    .collection("chats")
    .doc(currentChatId)
    .collection("messages")
    .add({
      testo: txt,
      mittente: "admin",
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

  chatInput.value = "";
}
</script>

</body>
</html>
