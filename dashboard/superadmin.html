<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SUPER ADMIN â€“ Chat & Segnalazioni</title>

<link rel="stylesheet" href="dashboard.css">

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script src="firebase-config.js"></script>
<script src="admin-auth.js"></script>
<script src="dashboard.js"></script>

<style>
.chat-box{background:#0e1b2a;padding:8px;border-radius:6px;max-height:200px;overflow-y:auto}
.chat-user{color:#90caf9}
.chat-admin{color:#00e676}
.chat-input{width:100%;margin-top:6px;padding:6px;border-radius:4px}
.btn{padding:6px 10px;border-radius:4px;cursor:pointer;font-weight:bold}
.btn-send{background:#00c853;color:#000}
.btn-reset{background:#ff9800}
.btn-archive{background:#607d8b;color:#fff}
.btn-clear{background:#d32f2f;color:#fff}
.status-ok{color:#00e676;font-weight:bold}
.status-archived{color:#ff9800;font-weight:bold}
</style>
</head>

<body>

<a class="logout-btn" onclick="adminLogout()">Logout</a>
<div class="header">SUPER ADMIN â€“ CHAT + SEGNALAZIONI</div>

<div class="content">

<!-- CHAT UTENTI -->
<h2>ðŸ’¬ CHAT UTENTI</h2>
<table class="table">
<thead>
<tr>
<th>Scala</th><th>Piano</th><th>Lato</th><th>Nome</th>
<th>Stato</th><th>Chat</th><th>Azioni</th>
</tr>
</thead>
<tbody id="chatTable">
<tr><td colspan="7">Caricamentoâ€¦</td></tr>
</tbody>
</table>

<hr>

<!-- SEGNALAZIONI -->
<h2>ðŸ“‹ TUTTE LE SEGNALAZIONI</h2>
<table class="table">
<thead>
<tr>
<th>Data</th><th>Scala</th><th>Piano</th><th>Lato</th>
<th>Nome</th><th>Temp</th><th>Tipo</th><th>Descrizione</th><th>Azioni</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

</div>

<script>
requireRole("superadmin");
loadSegnalazioni(r=>true,true);

const chatTable = document.getElementById("chatTable");

firebase.firestore().collection("chats")
.onSnapshot(snap=>{
  chatTable.innerHTML="";
  if(snap.empty){
    chatTable.innerHTML="<tr><td colspan='7'>Nessuna chat</td></tr>";
    return;
  }

  snap.forEach(doc=>{
    const d = doc.data();
    if(!d.meta) return;

    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${d.meta.scala}</td>
      <td>${d.meta.piano}</td>
      <td>${d.meta.lato}</td>
      <td>${d.meta.nome}</td>
      <td class="${d.meta.archived?'status-archived':'status-ok'}">
        ${d.meta.archived?'ARCHIVIATA':'ATTIVA'}
      </td>
      <td>
        <div class="chat-box" id="box-${doc.id}"></div>
        <textarea class="chat-input" id="input-${doc.id}" placeholder="Scrivi come admin..."></textarea>
        <button class="btn btn-send" onclick="sendAdmin('${doc.id}')">INVIA</button>
      </td>
      <td>
        <button class="btn btn-reset" onclick="resetPin('${doc.id}')">RESET PIN</button><br><br>
        <button class="btn btn-archive" onclick="archiveChat('${doc.id}')">ARCHIVIA</button><br><br>
        <button class="btn btn-clear" onclick="clearChat('${doc.id}')">CANCELLA TESTI</button>
      </td>
    `;
    chatTable.appendChild(tr);

    firebase.firestore().collection("chats")
      .doc(doc.id).collection("messages")
      .orderBy("timestamp")
      .onSnapshot(ms=>{
        const box=document.getElementById("box-"+doc.id);
        box.innerHTML="";
        ms.forEach(m=>{
          const x=m.data();
          const div=document.createElement("div");
          div.className=x.mittente==="admin"?"chat-admin":"chat-user";
          div.innerText=x.testo;
          box.appendChild(div);
        });
        box.scrollTop=box.scrollHeight;
      });
  });
});

function sendAdmin(chatId){
  const i=document.getElementById("input-"+chatId);
  const t=i.value.trim();
  if(!t) return;
  firebase.firestore().collection("chats").doc(chatId)
    .collection("messages").add({
      testo:t,
      mittente:"admin",
      timestamp:firebase.firestore.FieldValue.serverTimestamp()
    });
  i.value="";
}

function resetPin(chatId){
  if(!confirm("Reset PIN?")) return;
  firebase.firestore().collection("chats").doc(chatId)
    .update({"meta.pinHash":firebase.firestore.FieldValue.delete()});
}

function archiveChat(chatId){
  if(!confirm("Archiviare la chat?")) return;
  firebase.firestore().collection("chats").doc(chatId)
    .update({"meta.archived":true});
}

async function clearChat(chatId){
  if(!confirm("Cancellare SOLO i messaggi?")) return;
  const ref=firebase.firestore().collection("chats")
    .doc(chatId).collection("messages");
  const snap=await ref.get();
  snap.forEach(d=>d.ref.delete());
}
</script>

</body>
</html>
