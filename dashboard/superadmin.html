<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>SuperAdmin ‚Äì Tutte le Segnalazioni</title>

    <link rel="stylesheet" href="dashboard.css">

    <!-- FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <!-- CONFIG FIREBASE -->
    <script src="firebase-config.js"></script>

    <!-- LOGIN + RUOLI -->
    <script src="admin-auth.js"></script>

    <!-- LOGICA DASHBOARD -->
    <script src="dashboard.js"></script>

    <style>
        .logout-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            background: #ff0000;
            color: white;
            padding: 10px 18px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none;
            transition: 0.2s;
        }
        .logout-btn:hover { background: #cc0000; }

        .section {
            margin-bottom: 30px;
        }

        .section h2 {
            margin: 20px 0 10px;
            font-size: 20px;
        }

        .pin-status {
            font-weight: bold;
        }

        .pin-ok { color: #00c853; }
        .pin-reset { color: #ff9800; }

        .btn-reset {
            background: #ff9800;
            color: #000;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        .chat-box {
            background: #0e1b2a;
            border-radius: 8px;
            padding: 10px;
            max-height: 220px;
            overflow-y: auto;
        }

        .chat-msg {
            margin-bottom: 6px;
            font-size: 14px;
        }

        .chat-admin { color: #00e676; }
        .chat-user { color: #90caf9; }
    </style>
</head>

<body>

<a class="logout-btn" onclick="adminLogout()">Logout</a>

<div class="header">SUPER ADMIN ‚Äì TUTTE LE SEGNALAZIONI</div>

<div class="content">

<!-- =========================
     RESET PIN + CHAT UTENTI
========================= -->
<div class="section">
    <h2>üîê CHAT UTENTI ‚Äì RESET PIN</h2>

    <table class="table">
        <thead>
        <tr>
            <th>Scala</th>
            <th>Piano</th>
            <th>Lato</th>
            <th>Nome</th>
            <th>PIN Status</th>
            <th>Chat</th>
            <th>Azione</th>
        </tr>
        </thead>
        <tbody id="pinTable">
            <tr><td colspan="7">Caricamento‚Ä¶</td></tr>
        </tbody>
    </table>
</div>

<!-- =========================
     SEGNALAZIONI (LOGICA INTACT)
========================= -->
<div class="section">
    <h2>üìã TUTTE LE SEGNALAZIONI</h2>

    <table class="table">
        <thead>
        <tr>
            <th>Data</th>
            <th>Scala</th>
            <th>Piano</th>
            <th>Lato</th>
            <th>Nome</th>
            <th>Temp</th>
            <th>Tipo</th>
            <th>Descrizione</th>
            <th>Azioni</th>
        </tr>
        </thead>
        <tbody id="tbody"></tbody>
    </table>
</div>

</div>

<script>
console.log("[DEBUG] SuperAdmin ‚Äì pannello avviato");

/* Protezione accesso */
requireRole("superadmin");

/* LOGICA ORIGINALE ‚Äì NON TOCCATA */
loadSegnalazioni(
    r => true,
    true
);

/* ===============================
   RESET PIN + CHAT ‚Äì SOLO AGGIUNTA
=============================== */
const pinTable = document.getElementById("pinTable");

firebase.firestore()
    .collection("users_chat")
    .orderBy("nome")
    .onSnapshot(snap => {

        pinTable.innerHTML = "";

        if (snap.empty) {
            pinTable.innerHTML = `<tr><td colspan="7">Nessun utente chat</td></tr>`;
            return;
        }

        snap.forEach(doc => {
            const u = doc.data();
            const tr = document.createElement("tr");

            tr.innerHTML = `
                <td>${u.scala}</td>
                <td>${u.piano}</td>
                <td>${u.lato}</td>
                <td>${u.nome}</td>
                <td class="pin-status ${u.pinReset ? 'pin-reset' : 'pin-ok'}">
                    ${u.pinReset ? 'RESET RICHIESTO' : 'ATTIVO'}
                </td>
                <td>
                    <div class="chat-box" id="chat-${doc.id}">‚Ä¶</div>
                </td>
                <td>
                    <span class="btn-reset" onclick="resetPin('${doc.id}')">
                        RESET
                    </span>
                </td>
            `;

            pinTable.appendChild(tr);

            firebase.firestore()
                .collection("users_chat")
                .doc(doc.id)
                .collection("chat")
                .orderBy("timestamp")
                .limit(5)
                .onSnapshot(cs => {
                    const box = document.getElementById("chat-" + doc.id);
                    box.innerHTML = "";
                    cs.forEach(m => {
                        const d = m.data();
                        const div = document.createElement("div");
                        div.className = "chat-msg " + (d.mittente === "admin" ? "chat-admin" : "chat-user");
                        div.innerText = d.testo;
                        box.appendChild(div);
                    });
                });
        });
    });

function resetPin(userId) {
    if (!confirm("Resettare il PIN di questo utente?")) return;

    firebase.firestore()
        .collection("users_chat")
        .doc(userId)
        .update({
            pin: null,
            pinReset: false
        });
}
</script>

</body>
</html>
