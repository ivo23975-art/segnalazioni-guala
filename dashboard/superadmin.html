<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>SUPER ADMIN â€“ Chat + Segnalazioni</title>

<link rel="stylesheet" href="dashboard.css">

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<!-- CONFIG -->
<script src="firebase-config.js"></script>

<!-- AUTH -->
<script src="admin-auth.js"></script>

<!-- DASHBOARD -->
<script src="dashboard.js"></script>

<style>
.logout-btn{
  position:absolute;top:15px;right:20px;
  background:#ff0000;color:#fff;
  padding:10px 18px;border-radius:6px;
  cursor:pointer;font-weight:bold
}

.section{margin-bottom:30px}

.cards-top{
  display:flex;
  gap:20px;
  margin-bottom:30px
}

.chat-card{
  flex:1;
  padding:18px;
  border-radius:12px;
  font-size:20px;
  font-weight:bold;
  cursor:pointer;
  text-align:center;
  box-shadow:0 6px 18px rgba(0,0,0,.3);
  background:#e0e0e0;
}

.card-green{background:#00c853;color:#000}
.card-yellow{background:#ffeb3b;color:#000}
.card-red{background:#ff5252;color:#fff;animation:blink 1s infinite}
@keyframes blink{0%{opacity:1}50%{opacity:.5}100%{opacity:1}}

.chat-panel{display:none;margin-bottom:40px}

.chat-box{
  background:#0e1b2a;
  border-radius:8px;
  padding:10px;
  max-height:200px;
  overflow-y:auto
}

.chat-msg{margin-bottom:6px;font-size:14px}
.chat-user{color:#90caf9}
.chat-admin{color:#00e676}

textarea{
  width:100%;
  height:60px;
  border-radius:6px;
  padding:6px;
  margin-top:6px
}

.btn{padding:6px 10px;border-radius:4px;font-weight:bold;cursor:pointer}
.btn-send{background:#00c853;color:#000}
.btn-reset{background:#ff9800;color:#000}
.btn-archive{background:#607d8b;color:#fff}
.btn-clear{background:#d50000;color:#fff}

.status-archived{color:#ff9800;font-weight:bold}
.status-active{color:#00c853;font-weight:bold}
</style>
</head>

<body>

<a class="logout-btn" onclick="adminLogout()">Logout</a>

<div class="header">SUPER ADMIN â€“ CHAT + SEGNALAZIONI</div>

<div class="content">

<!-- =========================
     CARD DI TESTA
========================= -->
<div class="cards-top">
  <div id="cardGuala" class="chat-card" onclick="togglePanel('guala')">
    ðŸ’¬ CHAT GUALA (<span id="countGuala">0</span>)
  </div>
  <div id="cardPiobesi" class="chat-card" onclick="togglePanel('piobesi')">
    ðŸ’¬ CHAT PIOBESI (<span id="countPiobesi">0</span>)
  </div>
</div>

<!-- =========================
     CHAT GUALA
========================= -->
<div id="panel-guala" class="chat-panel">
<h2>Chat Guala</h2>
<table class="table">
<thead>
<tr>
<th>Scala</th><th>Piano</th><th>Lato</th><th>Nome</th>
<th>Stato</th><th>Chat</th><th>Azioni</th>
</tr>
</thead>
<tbody id="chatGuala"></tbody>
</table>
</div>

<!-- =========================
     CHAT PIOBESI
========================= -->
<div id="panel-piobesi" class="chat-panel">
<h2>Chat Piobesi</h2>
<table class="table">
<thead>
<tr>
<th>Scala</th><th>Piano</th><th>Lato</th><th>Nome</th>
<th>Stato</th><th>Chat</th><th>Azioni</th>
</tr>
</thead>
<tbody id="chatPiobesi"></tbody>
</table>
</div>

<!-- =========================
     SEGNALAZIONI (INTOCCATE)
========================= -->
<div class="section">
<h2>ðŸ“‹ TUTTE LE SEGNALAZIONI</h2>
<table class="table">
<thead>
<tr>
<th>Data</th><th>Scala</th><th>Piano</th><th>Lato</th>
<th>Nome</th><th>Temp</th><th>Tipo</th><th>Descrizione</th><th>Azioni</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

</div>

<script>
requireRole("superadmin");
loadSegnalazioni(r=>true,true);

let openPanel = null;

function togglePanel(c){
  const p = document.getElementById("panel-"+c);
  if(openPanel && openPanel!==p) openPanel.style.display="none";
  p.style.display = p.style.display==="block"?"none":"block";
  openPanel = p.style.display==="block"?p:null;
}

function setCardState(card,count){
  card.classList.remove("card-green","card-yellow","card-red");
  if(count>=7) card.classList.add("card-red");
  else if(count>=3) card.classList.add("card-yellow");
  else if(count>=1) card.classList.add("card-green");
}

function loadChats(complesso,tbodyId,cardId,countId){
  const tbody=document.getElementById(tbodyId);
  const card=document.getElementById(cardId);
  const counter=document.getElementById(countId);

  firebase.firestore().collection("chats")
  .where("meta.complesso","==",complesso)
  .onSnapshot(snap=>{
    tbody.innerHTML="";
    counter.innerText=snap.size;
    setCardState(card,snap.size);

    snap.forEach(doc=>{
      const d=doc.data();
      const m=d.meta||{};
      const archived=m.archived===true;

      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>${m.scala||""}</td>
        <td>${m.piano||""}</td>
        <td>${m.lato||""}</td>
        <td>${m.nome||""}</td>
        <td class="${archived?"status-archived":"status-active"}">
          ${archived?"ARCHIVIATA":"ATTIVA"}
        </td>
        <td>
          <div class="chat-box" id="box-${doc.id}"></div>
          <textarea id="input-${doc.id}" placeholder="Scrivi come admin..."></textarea>
          <button class="btn btn-send" onclick="sendAdmin('${doc.id}')">INVIA</button>
        </td>
        <td>
          <button class="btn btn-reset" onclick="resetPin('${doc.id}')">RESET PIN</button><br><br>
          <button class="btn btn-archive" onclick="toggleArchive('${doc.id}',${archived})">
            ${archived?"RIPRISTINA":"ARCHIVIA"}
          </button><br><br>
          <button class="btn btn-clear" onclick="clearChat('${doc.id}')">
            CANCELLA TESTI
          </button>
        </td>
      `;
      tbody.appendChild(tr);

      firebase.firestore().collection("chats")
      .doc(doc.id).collection("messages")
      .orderBy("timestamp")
      .onSnapshot(ms=>{
        const box=document.getElementById("box-"+doc.id);
        box.innerHTML="";
        ms.forEach(m=>{
          const msg=m.data();
          const div=document.createElement("div");
          div.className="chat-msg "+(msg.mittente==="admin"?"chat-admin":"chat-user");
          div.innerText=msg.testo;
          box.appendChild(div);
        });
        box.scrollTop=box.scrollHeight;
      });
    });
  });
}

loadChats("guala","chatGuala","cardGuala","countGuala");
loadChats("piobesi","chatPiobesi","cardPiobesi","countPiobesi");

function sendAdmin(id){
  const i=document.getElementById("input-"+id);
  const t=i.value.trim();
  if(!t)return;
  firebase.firestore().collection("chats")
  .doc(id).collection("messages")
  .add({
    testo:t,
    mittente:"admin",
    timestamp:firebase.firestore.FieldValue.serverTimestamp()
  });
  i.value="";
}

function resetPin(id){
  if(!confirm("Reset PIN utente?"))return;
  firebase.firestore().collection("chats")
  .doc(id).update({"meta.pinHash":null});
}

function toggleArchive(id,a){
  firebase.firestore().collection("chats")
  .doc(id).update({"meta.archived":!a});
}

function clearChat(id){
  if(!confirm("Cancellare SOLO i messaggi?"))return;
  firebase.firestore().collection("chats")
  .doc(id).collection("messages")
  .get().then(s=>{
    s.forEach(d=>d.ref.delete());
  });
}
</script>

</body>
</html>
