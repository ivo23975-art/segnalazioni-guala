<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>SuperAdmin – Gestione Segnalazioni & Chat</title>

    <link rel="stylesheet" href="dashboard.css">

    <!-- FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <!-- CONFIG FIREBASE -->
    <script src="firebase-config.js"></script>

    <!-- LOGIN + RUOLI -->
    <script src="admin-auth.js"></script>

    <!-- LOGICA DASHBOARD -->
    <script src="dashboard.js"></script>

    <style>
        .logout-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            background: #ff0000;
            color: white;
            padding: 10px 18px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none;
            transition: 0.2s;
        }
        .logout-btn:hover { background: #cc0000; }

        .section-title {
            margin: 30px 0 10px;
            font-size: 1.4rem;
            font-weight: bold;
        }

        .btn-reset {
            background: #ff8800;
            color: #000;
            border-radius: 6px;
            padding: 6px 10px;
            cursor: pointer;
            font-weight: bold;
            border: none;
        }
        .btn-reset:hover {
            background: #ffaa33;
        }
    </style>
</head>

<body>

<a class="logout-btn" onclick="adminLogout()">Logout</a>

<div class="header">SUPER ADMIN – CONTROLLO TOTALE</div>

<div class="content">

    <!-- ===========================
         SEGNALAZIONI (TUO)
    ============================ -->
    <div class="section-title">Segnalazioni</div>

    <table class="table">
        <thead>
        <tr>
            <th>Data</th>
            <th>Scala</th>
            <th>Piano</th>
            <th>Lato</th>
            <th>Nome</th>
            <th>Temp</th>
            <th>Tipo</th>
            <th>Descrizione</th>
            <th>Azioni</th>
        </tr>
        </thead>
        <tbody id="tbody"></tbody>
    </table>

    <!-- ===========================
         CHAT – RESET PIN
    ============================ -->
    <div class="section-title">Chat utenti – Reset PIN</div>

    <table class="table">
        <thead>
        <tr>
            <th>Complesso</th>
            <th>Scala</th>
            <th>Piano</th>
            <th>Lato</th>
            <th>Nome</th>
            <th>PIN</th>
            <th>Azione</th>
        </tr>
        </thead>
        <tbody id="chatBody"></tbody>
    </table>

</div>

<script>
console.log("[DEBUG] SuperAdmin – pannello avviato");

/* Protezione accesso */
requireRole("superadmin");

/* Segnalazioni: nessun filtro, elimina attivo */
loadSegnalazioni(r => true, true);

/* ===============================
   CHAT – LETTURA + RESET PIN
=============================== */
const chatBody = document.getElementById("chatBody");

db.collection("chats").orderBy("createdAt", "desc")
  .onSnapshot(snapshot => {

    let html = "";

    snapshot.forEach(doc => {
        const d = doc.data();
        const hasPin = !!d.pinHash;

        html += `
        <tr>
            <td>${d.complesso || "-"}</td>
            <td>${d.scala || "-"}</td>
            <td>${d.piano || "-"}</td>
            <td>${d.lato || "-"}</td>
            <td>${d.nome || "-"}</td>
            <td>${hasPin ? "✔ impostato" : "❌ assente"}</td>
            <td>
                <button class="btn-reset"
                    onclick="resetPin('${doc.id}')">
                    RESET PIN
                </button>
            </td>
        </tr>
        `;
    });

    chatBody.innerHTML = html;
});

/* ===============================
   RESET PIN (SUPER ADMIN)
=============================== */
function resetPin(chatId) {
    if (!confirm("Confermi il RESET del PIN?\nL’utente dovrà reimpostarlo.")) return;

    db.collection("chats").doc(chatId).update({
        pinHash: firebase.firestore.FieldValue.delete()
    })
    .then(() => {
        alert("PIN resettato correttamente.");
    })
    .catch(err => {
        alert("Errore reset PIN: " + err.message);
    });
}
</script>

</body>
</html>
