<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>SUPER ADMIN â€“ Chat + Segnalazioni</title>

<link rel="stylesheet" href="dashboard.css">
<link rel="icon" href="data:,">

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script src="firebase-config.js"></script>
<script src="admin-auth.js"></script>
<script src="dashboard.js"></script>

<style>
.logout-btn{position:absolute;top:15px;right:20px;background:#ff0000;color:#fff;padding:10px 18px;border-radius:6px;cursor:pointer;font-weight:bold}
.section{margin-bottom:30px}
.chat-cards{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:18px}
@media(max-width:900px){.chat-cards{grid-template-columns:1fr}}
.chat-card{background:#0f2a3d;border-radius:12px;padding:12px;color:#fff}
.chat-card-head{display:flex;justify-content:space-between;cursor:pointer;font-weight:900}
.chat-list{margin-top:10px;display:none;max-height:300px;overflow-y:auto}
.chat-item{background:#102f45;border-radius:10px;padding:10px;margin-bottom:8px;cursor:pointer}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;justify-content:center;align-items:center;z-index:9999}
.modal-content{background:#fff;width:92%;max-width:520px;height:78vh;border-radius:16px;padding:14px;display:flex;flex-direction:column}
.btn{margin-top:10px;padding:12px;width:100%;border:none;border-radius:12px;cursor:pointer;font-weight:900}
.btnSend{background:#00c853}
.btnReset{background:#ff9800}
.btnClose{background:#ccc}
</style>
</head>

<body>

<a class="logout-btn" onclick="adminLogout()">Logout</a>
<div class="header">SUPER ADMIN â€“ CHAT + SEGNALAZIONI</div>

<div class="content">

<div class="section">
<h2>ðŸ’¬ CHAT</h2>
<div class="chat-cards">
  <div class="chat-card">
    <div class="chat-card-head" onclick="toggleChatCard('guala')">Chat Guala â–¸</div>
    <div class="chat-list" id="listGuala"></div>
  </div>
  <div class="chat-card">
    <div class="chat-card-head" onclick="toggleChatCard('piobesi')">Chat Piobesi â–¸</div>
    <div class="chat-list" id="listPiobesi"></div>
  </div>
</div>
</div>

<div class="section">
<h2>ðŸ“‹ TUTTE LE SEGNALAZIONI</h2>
<table class="table">
<thead>
<tr>
<th>Data</th><th>Scala</th><th>Piano</th><th>Lato</th>
<th>Nome</th><th>Temp</th><th>Tipo</th><th>Descrizione</th><th>Az.</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

</div>

<div class="modal" id="modalChat">
<div class="modal-content">
<h3 id="chatTitle"></h3>
<div id="chatMessages" style="flex:1;overflow:auto"></div>
<textarea id="chatInput" placeholder="Scrivi come admin..."></textarea>
<button class="btn btnSend" onclick="sendAdminMessage()">Invia</button>
<button class="btn btnReset" onclick="resetAllSuperAdmin()">RESET ACCESSI UTENTE</button>
<button class="btn btnClose" onclick="closeChatModal()">Chiudi</button>
</div>
</div>

<script>
requireRole("superadmin");
loadSegnalazioni(r=>true,true);

const fdb = firebase.firestore();
let chatOpenDocId = null;
let chatOpenMeta = null;

function toggleChatCard(c){
  const el = document.getElementById(c === "guala" ? "listGuala" : "listPiobesi");
  el.style.display = el.style.display === "block" ? "none" : "block";
}

function openChatByDocId(id, meta){
  chatOpenDocId = id;
  chatOpenMeta = meta;
  document.getElementById("chatTitle").innerText =
    `${meta.nome} â€¢ ${meta.scala} â€¢ ${meta.piano} â€¢ ${meta.lato}`;
  document.getElementById("modalChat").style.display = "flex";

  fdb.collection("chats").doc(id).collection("messages")
    .orderBy("timestamp")
    .onSnapshot(s=>{
      const box = document.getElementById("chatMessages");
      box.innerHTML = "";
      s.forEach(d=>{
        const m = d.data();
        const div = document.createElement("div");
        div.innerText = m.testo;
        box.appendChild(div);
      });
      box.scrollTop = box.scrollHeight;
    });
}

function closeChatModal(){
  document.getElementById("modalChat").style.display = "none";
  chatOpenDocId = null;
  chatOpenMeta = null;
}

function sendAdminMessage(){
  const t = document.getElementById("chatInput").value.trim();
  if(!t || !chatOpenDocId) return;
  fdb.collection("chats").doc(chatOpenDocId)
    .collection("messages")
    .add({ testo:t, mittente:"admin", timestamp:firebase.firestore.FieldValue.serverTimestamp() });
  document.getElementById("chatInput").value="";
}

/* ===== RESET UNICO ===== */
async function resetAllSuperAdmin(){
  if(!chatOpenDocId || !chatOpenMeta) return;
  if(!confirm("Reset COMPLETO accessi utente?")) return;

  await fdb.collection("chats").doc(chatOpenDocId)
    .update({ "meta.pinHash": null });

  const m = chatOpenMeta;
  const snap = await fdb.collection("segnalazioni")
    .where("complesso","==",m.complesso)
    .where("scala","==",m.scala)
    .where("piano","==",m.piano)
    .where("lato","==",m.lato)
    .where("nome","==",m.nome)
    .limit(1).get();

  if(!snap.empty){
    await fdb.collection("segnalazioni_pin")
      .doc(snap.docs[0].id)
      .set({
        pinHash:"",
        createdAt:firebase.firestore.FieldValue.serverTimestamp()
      });
  }

  alert("Reset completato.");
}

/* ===== LISTE CHAT ===== */
fdb.collection("chats").onSnapshot(s=>{
  listGuala.innerHTML="";
  listPiobesi.innerHTML="";
  s.forEach(d=>{
    const m = d.data().meta || {};
    const el = document.createElement("div");
    el.className="chat-item";
    el.innerText = `${m.nome || ""} ${m.scala || ""}`;
    el.onclick=()=>openChatByDocId(d.id,m);
    if((m.complesso||"").toLowerCase()==="guala") listGuala.appendChild(el);
    if((m.complesso||"").toLowerCase()==="piobesi") listPiobesi.appendChild(el);
  });
});
</script>

</body>
</html>
