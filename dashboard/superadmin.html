<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>SUPER ADMIN v2 â€“ Chat + Segnalazioni</title>

<link rel="stylesheet" href="dashboard.css">

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<!-- CONFIG -->
<script src="firebase-config.js"></script>
<script src="admin-auth.js"></script>
<script src="dashboard.js"></script>

<style>
.logout-btn{
  position:absolute;top:15px;right:20px;
  background:#ff0000;color:#fff;
  padding:10px 18px;border-radius:6px;
  cursor:pointer;font-weight:bold
}

.section{margin-bottom:40px}

.chat-toggle{
  padding:10px;
  border-radius:8px;
  cursor:pointer;
  font-weight:bold;
  text-align:center;
  margin-bottom:10px;
}

.chat-green{background:#00c853;color:#000}
.chat-yellow{background:#ffeb3b;color:#000}
.chat-red{background:#ff5252;color:#fff;animation:blink 1s infinite}

@keyframes blink{
  0%,100%{opacity:1}
  50%{opacity:.5}
}

.chat-container{display:none;margin-bottom:30px}

.chat-box{
  background:#0e1b2a;
  border-radius:8px;
  padding:10px;
  max-height:220px;
  overflow-y:auto
}

.chat-msg{margin-bottom:6px;font-size:14px}
.chat-user{color:#90caf9}
.chat-admin{color:#00e676}

textarea{
  width:100%;
  height:60px;
  border-radius:6px;
  padding:6px;
  margin-top:6px
}

.btn{padding:6px 10px;border-radius:4px;font-weight:bold;cursor:pointer;margin-top:4px}
.btn-send{background:#00c853;color:#000}
.btn-reset{background:#ff9800;color:#000}
.btn-archive{background:#607d8b;color:#fff}
.btn-clear{background:#d50000;color:#fff}

.status-archived{color:#ff9800;font-weight:bold}
.status-active{color:#00c853;font-weight:bold}
</style>
</head>

<body>

<a class="logout-btn" onclick="adminLogout()">Logout</a>

<div class="header">SUPER ADMIN v2 â€“ CHAT + SEGNALAZIONI</div>

<div class="content">

<!-- =========================
     CHAT GUALA
========================= -->
<div class="section">
<div id="toggle-guala" class="chat-toggle chat-green" onclick="toggleChat('guala')">
ðŸ’¬ CHAT GUALA (0)
</div>
<div id="chat-guala" class="chat-container"></div>
</div>

<!-- =========================
     CHAT PIOBESI
========================= -->
<div class="section">
<div id="toggle-piobesi" class="chat-toggle chat-green" onclick="toggleChat('piobesi')">
ðŸ’¬ CHAT PIOBESI (0)
</div>
<div id="chat-piobesi" class="chat-container"></div>
</div>

<!-- =========================
     SEGNALAZIONI (INVARIATE)
========================= -->
<div class="section">
<h2>ðŸ“‹ TUTTE LE SEGNALAZIONI</h2>
<table class="table">
<thead>
<tr>
<th>Data</th><th>Scala</th><th>Piano</th><th>Lato</th>
<th>Nome</th><th>Temp</th><th>Tipo</th><th>Descrizione</th><th>Azioni</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

</div>

<script>
requireRole("superadmin");
loadSegnalazioni(r=>true,true);

const dbRef = firebase.firestore();

/* =========================
   TOGGLE CHAT
========================= */
function toggleChat(c){
  const el=document.getElementById("chat-"+c);
  el.style.display=el.style.display==="block"?"none":"block";
}

/* =========================
   RENDER CHAT SECTION
========================= */
function renderChatSection(complesso){
  const container=document.getElementById("chat-"+complesso);
  const toggle=document.getElementById("toggle-"+complesso);

  dbRef.collection("chats")
    .where("meta.complesso","==",complesso)
    .onSnapshot(snap=>{
      container.innerHTML="";
      let unreadTotal=0;

      snap.forEach(doc=>{
        const d=doc.data();
        const m=d.meta||{};
        const chatId=doc.id;

        if(!m.nome)return;

        dbRef.collection("chats").doc(chatId)
          .collection("messages")
          .where("timestamp",">",m.lastReadAdminAt||new Date(0))
          .get()
          .then(unreadSnap=>{
            unreadTotal+=unreadSnap.size;
            updateToggle(toggle,unreadTotal);
          });

        const wrap=document.createElement("div");
        wrap.style.borderBottom="1px solid #333";
        wrap.style.paddingBottom="10px";
        wrap.style.marginBottom="10px";

        wrap.innerHTML=`
<b>${m.nome} â€“ ${m.scala} ${m.piano} ${m.lato}</b>
<span class="${m.archived?'status-archived':'status-active'}">
 ${m.archived?' ARCHIVIATA':' ATTIVA'}
</span>
<div class="chat-box" id="box-${chatId}"></div>
<textarea id="input-${chatId}" placeholder="Scrivi come admin..."></textarea>
<button class="btn btn-send" onclick="sendAdmin('${chatId}')">INVIA</button>
<button class="btn btn-reset" onclick="resetPin('${chatId}')">RESET PIN</button>
<button class="btn btn-archive" onclick="toggleArchive('${chatId}',${m.archived===true})">
${m.archived?'RIPRISTINA':'ARCHIVIA'}
</button>
<button class="btn btn-clear" onclick="clearChat('${chatId}')">CANCELLA TESTI</button>
        `;
        container.appendChild(wrap);

        dbRef.collection("chats").doc(chatId)
          .collection("messages")
          .orderBy("timestamp","asc")
          .onSnapshot(ms=>{
            const box=document.getElementById("box-"+chatId);
            box.innerHTML="";
            ms.forEach(mm=>{
              const msg=mm.data();
              const div=document.createElement("div");
              div.className="chat-msg "+(msg.mittente==="admin"?"chat-admin":"chat-user");
              div.innerText=msg.testo;
              box.appendChild(div);
            });
            box.scrollTop=box.scrollHeight;
          });
      });

      updateToggle(toggle,unreadTotal);
    });
}

function updateToggle(el,count){
  el.innerText=el.innerText.split("(")[0]+"("+count+")";
  el.className="chat-toggle "+
    (count>=7?"chat-red":count>=3?"chat-yellow":"chat-green");
}

/* =========================
   CHAT ACTIONS
========================= */
function sendAdmin(id){
  const input=document.getElementById("input-"+id);
  const txt=input.value.trim();
  if(!txt)return;

  dbRef.collection("chats").doc(id).collection("messages").add({
    testo:txt,
    mittente:"admin",
    timestamp:firebase.firestore.FieldValue.serverTimestamp()
  });

  dbRef.collection("chats").doc(id).update({
    "meta.lastReadAdminAt":firebase.firestore.FieldValue.serverTimestamp()
  });

  input.value="";
}

function resetPin(id){
  if(!confirm("Reset PIN utente?"))return;
  dbRef.collection("chats").doc(id).update({"meta.pinHash":null});
}

function toggleArchive(id,a){
  dbRef.collection("chats").doc(id).update({"meta.archived":!a});
}

function clearChat(id){
  if(!confirm("Cancellare SOLO i messaggi?"))return;
  dbRef.collection("chats").doc(id).collection("messages").get()
    .then(snap=>snap.forEach(d=>d.ref.delete()));
}

/* =========================
   INIT
========================= */
renderChatSection("guala");
renderChatSection("piobesi");
</script>

</body>
</html>
