<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Guala â€“ Segnalazioni attive</title>

    <link rel="stylesheet" href="dashboard.css">

    <!-- FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <!-- CONFIG -->
    <script src="firebase-config.js"></script>

    <!-- AUTH -->
    <script src="admin-auth.js"></script>

    <!-- DASHBOARD -->
    <script src="dashboard.js"></script>

    <style>
        .logout-btn{
            position: fixed;
            top: 12px;
            right: 20px;
            background: #ff4444;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            z-index: 9999;
        }

        /* ===== CHAT GUALA ===== */
        .chat-card{
            background:#0f2a3d;
            color:#fff;
            border-radius:12px;
            padding:14px;
            margin-bottom:20px;
            cursor:pointer;
        }

        .chat-list{
            margin-top:10px;
            display:none;
        }

        .chat-item{
            background:#102f45;
            padding:10px;
            border-radius:8px;
            margin-bottom:8px;
            cursor:pointer;
        }

        .chat-modal{
            position:fixed;
            inset:0;
            background:rgba(0,0,0,.5);
            display:none;
            align-items:center;
            justify-content:center;
            z-index:9999;
        }

        .chat-modal-content{
            background:#fff;
            width:90%;
            max-width:500px;
            height:70vh;
            border-radius:12px;
            padding:12px;
            display:flex;
            flex-direction:column;
        }

        .chat-messages{
            flex:1;
            overflow-y:auto;
            margin:10px 0;
            background:#f5f5f5;
            padding:10px;
            border-radius:8px;
            color:#000;
        }

        .msg-user{color:#000;}
        .msg-guala{color:#000;font-weight:bold;}

        textarea{
            width:100%;
            height:60px;
            border-radius:8px;
            padding:8px;
            color:#000;
        }
    </style>
</head>

<body>

<a class="logout-btn" onclick="adminLogout()">Logout</a>

<div class="header">Guala â€“ Segnalazioni attive</div>

<div class="content">

<!-- ================= CHAT GUALA (ISOLATA) ================= -->
<div class="chat-card" onclick="toggleChat()">
    ðŸ’¬ Chat Guala
    <div class="chat-list" id="chatList">Caricamento chatâ€¦</div>
</div>

<!-- ======================= SEGNALAZIONI (INTOCCATE) ======================= -->
<table class="table">
<thead>
<tr>
    <th>Data</th>
    <th>Scala</th>
    <th>Piano</th>
    <th>Lato</th>
    <th>Nome</th>
    <th>Temp</th>
    <th>Tipo</th>
    <th>Descrizione</th>
    <th>Azioni</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

</div>

<!-- ================= MODALE CHAT ================= -->
<div class="chat-modal" id="chatModal">
    <div class="chat-modal-content">
        <h3 id="chatTitle"></h3>
        <div class="chat-messages" id="chatMessages"></div>
        <textarea id="chatInput" placeholder="Scrivi messaggio..."></textarea>
        <button onclick="sendMsg()">Invia</button>
        <button onclick="closeChat()">Chiudi</button>
    </div>
</div>

<script>
requireRole("guala");

/* ================= SEGNALAZIONI (IDENTICHE) ================= */
loadSegnalazioni(
    r => r.stato === "attiva" && r.complesso === "guala"
);

/* ================= CHAT GUALA ================= */
const db = firebase.firestore();
let currentChatId = null;
let unsub = null;

function toggleChat(){
    const el = document.getElementById("chatList");
    el.style.display = el.style.display === "block" ? "none" : "block";
}

db.collection("chats")
  .where("meta.complesso","==","guala")
  .onSnapshot(snap=>{
    const list = document.getElementById("chatList");
    list.innerHTML = "";
    snap.forEach(doc=>{
        const m = doc.data().meta;
        const div = document.createElement("div");
        div.className = "chat-item";
        div.innerText = `${m.nome} â€“ ${m.scala} ${m.piano} ${m.lato}`;
        div.onclick = ()=>openChat(doc.id,m);
        list.appendChild(div);
    });
  });

function openChat(id,meta){
    currentChatId = id;
    document.getElementById("chatTitle").innerText =
        `${meta.nome} â€“ ${meta.scala} ${meta.piano} ${meta.lato}`;
    document.getElementById("chatModal").style.display = "flex";
    const box = document.getElementById("chatMessages");
    box.innerHTML = "";

    if(unsub) unsub();

    unsub = db.collection("chats")
      .doc(id).collection("messages")
      .orderBy("timestamp")
      .onSnapshot(s=>{
        box.innerHTML="";
        s.forEach(d=>{
            const msg = d.data();
            const div = document.createElement("div");
            div.className = msg.mittente === "user" ? "msg-user" : "msg-guala";
            div.innerText = msg.testo;
            box.appendChild(div);
        });
        box.scrollTop = box.scrollHeight;
      });
}

function closeChat(){
    document.getElementById("chatModal").style.display="none";
    if(unsub) unsub();
}

function sendMsg(){
    const t = chatInput.value.trim();
    if(!t || !currentChatId) return;
    db.collection("chats")
      .doc(currentChatId)
      .collection("messages")
      .add({
        testo:t,
        mittente:"guala",
        timestamp:firebase.firestore.FieldValue.serverTimestamp()
      });
    chatInput.value="";
}
</script>

</body>
</html>
