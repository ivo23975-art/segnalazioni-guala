<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Guala â€“ Segnalazioni attive</title>

    <link rel="stylesheet" href="dashboard.css">

    <!-- FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <!-- CONFIG -->
    <script src="firebase-config.js"></script>

    <!-- AUTH -->
    <script src="admin-auth.js"></script>

    <!-- DASHBOARD -->
    <script src="dashboard.js"></script>

    <style>
        .logout-btn {
            position: fixed;
            top: 12px;
            right: 20px;
            background: #ff4444;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            z-index: 9999;
        }

        .chat-admin-box {
            margin-top: 30px;
            border-top: 2px solid #333;
            padding-top: 20px;
        }

        .chat-list button {
            margin: 5px;
            padding: 6px 10px;
            cursor: pointer;
        }

        .chat-window {
            margin-top: 10px;
            border: 1px solid #333;
            padding: 10px;
            background: #111;
        }

        .chat-msg.admin { color: #00e676; }
        .chat-msg.user { color: #90caf9; }

        textarea {
            width: 100%;
            margin-top: 10px;
        }
    </style>
</head>

<body>

<a class="logout-btn" onclick="adminLogout()">Logout</a>

<div class="header">Guala â€“ Segnalazioni attive</div>

<div class="content">

<!-- =======================
     SEGNALAZIONI
======================= -->
<table class="table">
<thead>
<tr>
    <th>Data</th>
    <th>Scala</th>
    <th>Piano</th>
    <th>Lato</th>
    <th>Nome</th>
    <th>Temp</th>
    <th>Tipo</th>
    <th>Descrizione</th>
    <th>Azioni</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<!-- =======================
     CHAT ATTUALE (CHATS/)
======================= -->
<div class="chat-admin-box">
    <h2>ðŸ’¬ Chat utenti</h2>

    <div class="chat-list" id="chatList">Caricamento chatâ€¦</div>

    <div class="chat-window" id="chatWindow" style="display:none;">
        <h3 id="chatTitle"></h3>
        <div id="chatMessages"></div>
        <textarea id="chatInput" placeholder="Scrivi messaggio..."></textarea>
        <button onclick="sendAdminMsg()">Invia</button>
    </div>
</div>

</div>

<script>
requireRole("guala");

/* SEGNALAZIONI */
loadSegnalazioni(
    r => r.stato === "attiva" && r.complesso === "guala"
);

/* =========================
   CHAT ATTUALE (chats/)
========================= */
let currentChatId = null;
let unsubscribeChat = null;

const chatList = document.getElementById("chatList");
const chatWindow = document.getElementById("chatWindow");
const chatMessages = document.getElementById("chatMessages");

db.collection("chats").orderBy("meta.nome")
.onSnapshot(snap => {
    chatList.innerHTML = "";
    if (snap.empty) {
        chatList.innerText = "Nessuna chat attiva";
        return;
    }

    snap.forEach(doc => {
        const d = doc.data();
        const btn = document.createElement("button");
        btn.innerText = d.meta.nome;
        btn.onclick = () => openChat(doc.id, d.meta);
        chatList.appendChild(btn);
    });
});

function openChat(id, meta) {
    currentChatId = id;
    chatWindow.style.display = "block";
    document.getElementById("chatTitle").innerText =
        `${meta.nome} â€“ ${meta.scala} ${meta.piano} ${meta.lato}`;

    if (unsubscribeChat) unsubscribeChat();

    unsubscribeChat = db.collection("chats")
        .doc(id)
        .collection("messages")
        .orderBy("timestamp")
        .onSnapshot(snap => {
            chatMessages.innerHTML = "";
            snap.forEach(m => {
                const msg = m.data();
                const div = document.createElement("div");
                div.className = "chat-msg " + msg.mittente;
                div.innerText = msg.testo;
                chatMessages.appendChild(div);
            });
        });
}

function sendAdminMsg() {
    const input = document.getElementById("chatInput");
    const text = input.value.trim();
    if (!text || !currentChatId) return;

    db.collection("chats")
      .doc(currentChatId)
      .collection("messages")
      .add({
          testo: text,
          mittente: "admin",
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });

    input.value = "";
}
</script>

</body>
</html>
