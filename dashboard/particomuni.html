<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Parti Comuni â€“ Chat + Segnalazioni</title>

<link rel="stylesheet" href="dashboard.css">
<link rel="icon" href="data:,">

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<!-- CONFIG -->
<script src="firebase-config.js"></script>

<!-- AUTH -->
<script src="admin-auth.js"></script>

<!-- DASHBOARD -->
<script src="dashboard.js"></script>

<style>
.logout-btn{
  position:fixed;top:12px;right:20px;
  background:#ff0000;color:#fff;
  padding:8px 16px;border-radius:8px;
  font-weight:bold;cursor:pointer;z-index:9999
}
.section{margin-bottom:18px}

/* ===== CHAT ===== */
.chat-cards{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:14px;
  margin-bottom:18px
}
@media(max-width:900px){
  .chat-cards{grid-template-columns:1fr}
}
.chat-card{
  background:#0f2a3d;
  border-radius:12px;
  padding:12px;
  color:#fff;
  border:1px solid rgba(255,255,255,.08);
  transform:translateZ(0)
}

/* ===== LAMPEGGIO ===== */
.chat-card.attn{
  animation:blink 1.2s infinite;
  border-color:rgba(255,204,0,.7);
  box-shadow:0 0 22px rgba(255,204,0,.35)
}
@keyframes blink{
  0%,100%{filter:brightness(1)}
  50%{filter:brightness(1.25)}
}

.chat-card-head{
  display:flex;justify-content:space-between;
  font-weight:900;cursor:pointer
}
.chat-card-sub{
  font-size:13px;opacity:.85;
  display:flex;justify-content:space-between;
  margin-top:6px
}
.chat-list{
  display:none;margin-top:10px;
  max-height:320px;overflow-y:auto
}
.chat-item{
  background:#102f45;
  border-radius:10px;
  padding:10px;
  margin-bottom:8px;
  display:flex;justify-content:space-between;
  cursor:pointer
}
.chat-item .title{font-weight:900}
.chat-item .meta{font-size:12px;opacity:.8}
.badge{
  font-size:11px;
  padding:4px 8px;
  border-radius:999px;
  font-weight:900;
  background:#ffcc00;color:#111
}

/* ===== MODAL ===== */
.modal{
  position:fixed;inset:0;
  background:rgba(0,0,0,.45);
  display:none;justify-content:center;align-items:center
}
.modal-content{
  background:#fff;
  width:92%;max-width:520px;
  height:78vh;border-radius:16px;
  padding:14px;display:flex;flex-direction:column
}
#chatTitle,#chatDocHint{color:#000;text-align:center}
#chatMessages{
  flex:1;overflow-y:auto;
  background:#fafafa;border-radius:12px;
  padding:10px;margin-top:10px
}
.chat-bubble{
  max-width:82%;padding:.6rem;
  border-radius:.9rem;margin:.3rem 0;
  color:#000
}
.chat-bubble-user{background:#e6f2ff}
.chat-bubble-admin{background:#d6ffd6;margin-left:auto}
.chat-time{font-size:.75rem;opacity:.65;text-align:right;color:#000}
textarea{color:#000}
.btn{margin-top:10px;padding:12px;border-radius:12px;font-weight:900}
.btnSend{background:#00c853}
.btnClose{background:#ccc}
</style>
</head>

<body>

<a class="logout-btn" onclick="adminLogout()">Logout</a>
<div class="header">Parti Comuni â€“ Chat + Segnalazioni</div>

<div class="content">

<!-- ===== CHAT ===== -->
<div class="section">
<div class="chat-cards">

<div class="chat-card" id="cardGuala">
  <div class="chat-card-head" onclick="toggleCard('guala')">
    <div>ðŸ’¬ Chat Guala</div><div id="chevGuala">â–¸</div>
  </div>
  <div class="chat-card-sub">Chat Parti Comuni â€“ Guala</div>
  <div class="chat-list" id="listGuala"></div>
</div>

<div class="chat-card" id="cardPiobesi">
  <div class="chat-card-head" onclick="toggleCard('piobesi')">
    <div>ðŸ’¬ Chat Piobesi</div><div id="chevPiobesi">â–¸</div>
  </div>
  <div class="chat-card-sub">Chat Parti Comuni â€“ Piobesi</div>
  <div class="chat-list" id="listPiobesi"></div>
</div>

</div>
</div>

<!-- ===== SEGNALAZIONI (INVARIATE) ===== -->
<table class="table">
<thead>
<tr>
<th>Data</th><th>Scala</th><th>Piano</th><th>Lato</th>
<th>Nome</th><th>Temp</th><th>Tipo</th>
<th>Descrizione</th><th>Risolvi</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

</div>

<!-- ===== MODAL ===== -->
<div class="modal" id="modalChat">
  <div class="modal-content">
    <h3 id="chatTitle"></h3>
    <div id="chatDocHint"></div>
    <div id="chatMessages"></div>
    <textarea id="chatInput"></textarea>
    <button class="btn btnSend" onclick="sendMsg()">Invia</button>
    <button class="btn btnClose" onclick="closeChat()">Chiudi</button>
  </div>
</div>

<script>
requireRole("particomuni");

/* SEGNALAZIONI */
loadSegnalazioni(
  r => (r.tipo==="Parti comuni"||r.tipo==="particomuni") && r.stato==="attiva"
);

/* ===== CHAT ===== */
const fdb = firebase.firestore();

const listGuala = document.getElementById("listGuala");
const listPiobesi = document.getElementById("listPiobesi");
const cardGuala = document.getElementById("cardGuala");
const cardPiobesi = document.getElementById("cardPiobesi");

const modalChat = document.getElementById("modalChat");
const chatTitle = document.getElementById("chatTitle");
const chatDocHint = document.getElementById("chatDocHint");
const chatMessages = document.getElementById("chatMessages");
const chatInput = document.getElementById("chatInput");

let openChatId=null;
let unsubChat=null;

function toggleCard(c){
  const list=c==="guala"?listGuala:listPiobesi;
  const chev=document.getElementById(c==="guala"?"chevGuala":"chevPiobesi");
  const open=list.style.display==="block";
  list.style.display=open?"none":"block";
  chev.innerText=open?"â–¸":"â–¾";
}

function openChat(id,meta){
  openChatId=id;
  modalChat.style.display="flex";
  chatTitle.innerText=`Chat â€¢ ${meta.nome||""}`;
  chatDocHint.innerText=id;
  chatMessages.innerHTML="";
  cardGuala.classList.remove("attn");
  cardPiobesi.classList.remove("attn");

  if(unsubChat)unsubChat();
  unsubChat=fdb.collection("chats").doc(id)
    .collection("messages").orderBy("timestamp","asc")
    .onSnapshot(s=>{
      chatMessages.innerHTML="";
      s.forEach(d=>{
        const m=d.data();
        const b=document.createElement("div");
        b.className="chat-bubble "+(m.mittente==="admin"?"chat-bubble-admin":"chat-bubble-user");
        b.innerHTML=`${m.testo||""}<div class="chat-time">${m.timestamp?.toDate().toLocaleTimeString()}</div>`;
        chatMessages.appendChild(b);
      });
      chatMessages.scrollTop=999999;
    });
}

function closeChat(){
  modalChat.style.display="none";
  if(unsubChat)unsubChat();
  unsubChat=null;
}

function sendMsg(){
  if(!openChatId||!chatInput.value)return;
  fdb.collection("chats").doc(openChatId)
    .collection("messages")
    .add({
      testo:chatInput.value,
      mittente:"admin",
      timestamp:firebase.firestore.FieldValue.serverTimestamp()
    });
  chatInput.value="";
}

/* ===== INDICE + LAMPEGGIO ===== */
fdb.collection("chats")
.where("meta.destinatario","==","particomuni")
.onSnapshot(snap=>{
  listGuala.innerHTML="";
  listPiobesi.innerHTML="";
  let blinkG=false, blinkP=false;

  snap.forEach(doc=>{
    const m=(doc.data()||{}).meta||{};
    if(!m.complesso)return;

    const row=document.createElement("div");
    row.className="chat-item";
    row.innerHTML=`
      <div>
        <div class="title">${m.nome||""}</div>
        <div class="meta">${m.scala||""} â€¢ ${m.piano||""} â€¢ ${m.lato||""}</div>
      </div>
      <div class="badge">PC</div>
    `;
    row.onclick=()=>openChat(doc.id,m);

    if(m.complesso==="guala"){listGuala.appendChild(row);blinkG=true}
    if(m.complesso==="piobesi"){listPiobesi.appendChild(row);blinkP=true}
  });

  if(blinkG)cardGuala.classList.add("attn");
  if(blinkP)cardPiobesi.classList.add("attn");
});
</script>

</body>
</html>
