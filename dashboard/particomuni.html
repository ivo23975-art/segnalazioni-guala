<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Parti Comuni â€“ Segnalazioni attive</title>

<link rel="stylesheet" href="dashboard.css">

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<!-- CONFIG -->
<script src="firebase-config.js"></script>

<!-- AUTH -->
<script src="admin-auth.js"></script>

<!-- DASHBOARD -->
<script src="dashboard.js"></script>

<style>
.logout-btn{
  position:absolute;
  top:15px;
  right:20px;
  background:#ff0000;
  color:white;
  padding:10px 18px;
  border-radius:6px;
  font-weight:bold;
  cursor:pointer;
}

.chat-box{
  margin-top:30px;
  border-top:2px solid #333;
  padding-top:20px;
}

.chat-list button{
  margin:5px;
  padding:6px 10px;
  cursor:pointer;
  border-radius:6px;
  border:none;
  background:#1e3a5f;
  color:white;
}

.chat-window{
  margin-top:10px;
  border:1px solid #333;
  padding:10px;
  background:#111;
  border-radius:8px;
}

.chat-msg.admin{color:#00e676;margin:4px 0;}
.chat-msg.user{color:#90caf9;margin:4px 0;}

textarea{
  width:100%;
  margin-top:10px;
  resize:none;
}
</style>
</head>

<body>

<a class="logout-btn" onclick="adminLogout()">Logout</a>

<div class="header">Parti Comuni â€“ Segnalazioni attive</div>

<div class="content">

<!-- ======================
     SEGNALAZIONI
====================== -->
<table class="table">
<thead>
<tr>
<th>Data</th>
<th>Scala</th>
<th>Piano</th>
<th>Lato</th>
<th>Nome</th>
<th>Temp</th>
<th>Tipo</th>
<th>Descrizione</th>
<th>Risolvi</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<!-- ======================
     CHAT 1â†”1 (DESTINATARIO)
====================== -->
<div class="chat-box">
<h2>ðŸ’¬ Chat utenti (Parti Comuni)</h2>

<div class="chat-list" id="chatList">Caricamento chatâ€¦</div>

<div class="chat-window" id="chatWindow" style="display:none;">
  <h3 id="chatTitle"></h3>
  <div id="chatMessages"></div>
  <textarea id="chatInput" placeholder="Scrivi risposta..."></textarea>
  <button onclick="sendPartiComuniMsg()">Invia</button>
</div>
</div>

</div>

<script>
requireRole("particomuni");

/* ======================
   SEGNALAZIONI
====================== */
loadSegnalazioni(
  r =>
    (r.tipo === "Parti comuni" || r.tipo === "particomuni") &&
    r.stato === "attiva"
);

/* ======================
   CHAT 1â†”1 â€” PARTI COMUNI
   - destinatario
   - NO broadcast
====================== */
let currentChatId = null;
let unsubscribeChat = null;

const chatList     = document.getElementById("chatList");
const chatWindow   = document.getElementById("chatWindow");
const chatMessages = document.getElementById("chatMessages");

/* Elenco chat destinate a PARTI COMUNI */
db.collection("chats")
  .where("meta.destinatario", "==", "particomuni")
  .orderBy("meta.nome")
  .onSnapshot(snapshot => {

    chatList.innerHTML = "";

    if (snapshot.empty) {
      chatList.innerText = "Nessuna chat attiva";
      return;
    }

    snapshot.forEach(doc => {
      const d = doc.data();
      const btn = document.createElement("button");

      btn.innerText = `${d.meta.nome} â€“ ${d.meta.scala} ${d.meta.piano} ${d.meta.lato}`;
      btn.onclick = () => openChat(doc.id, d.meta);

      chatList.appendChild(btn);
    });
  });

function openChat(chatId, meta){
  currentChatId = chatId;
  chatWindow.style.display = "block";

  document.getElementById("chatTitle").innerText =
    `Chat â€¢ ${meta.nome} â€¢ ${meta.scala} ${meta.piano} ${meta.lato}`;

  if (unsubscribeChat) unsubscribeChat();

  unsubscribeChat = db.collection("chats")
    .doc(chatId)
    .collection("messages")
    .orderBy("timestamp", "asc")
    .onSnapshot(snapshot => {

      chatMessages.innerHTML = "";

      snapshot.forEach(doc => {
        const m = doc.data();
        const div = document.createElement("div");
        div.className = "chat-msg " + m.mittente;
        div.innerText = m.testo;
        chatMessages.appendChild(div);
      });
    });
}

function sendPartiComuniMsg(){
  const input = document.getElementById("chatInput");
  const text = input.value.trim();
  if (!text || !currentChatId) return;

  db.collection("chats")
    .doc(currentChatId)
    .collection("messages")
    .add({
      testo: text,
      mittente: "admin",
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

  input.value = "";
}
</script>

</body>
</html>
