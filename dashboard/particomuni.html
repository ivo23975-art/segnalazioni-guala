<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Parti Comuni â€“ Segnalazioni attive</title>

<link rel="stylesheet" href="dashboard.css">

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<!-- CONFIG -->
<script src="firebase-config.js"></script>

<!-- AUTH -->
<script src="admin-auth.js"></script>

<!-- DASHBOARD -->
<script src="dashboard.js"></script>

<style>
.logout-btn{
  position:absolute;top:15px;right:20px;
  background:#ff0000;color:white;
  padding:10px 18px;border-radius:6px;
  font-weight:bold;cursor:pointer;
}

.chat-section{
  margin-top:30px;
  border-top:2px solid #333;
  padding-top:20px;
}

.chat-list button{
  margin:5px;
  padding:6px 10px;
  cursor:pointer;
}

.chat-window{
  margin-top:10px;
  border:1px solid #333;
  padding:10px;
  background:#111;
}

.chat-msg.admin{color:#00e676;margin-bottom:6px}
.chat-msg.user{color:#90caf9;margin-bottom:6px}

textarea{width:100%;margin-top:10px}
</style>
</head>

<body>

<a class="logout-btn" onclick="adminLogout()">Logout</a>

<div class="header">Parti Comuni â€“ Segnalazioni attive</div>

<div class="content">

<!-- ======================
     SEGNALAZIONI (INVARIATE)
====================== -->
<table class="table">
<thead>
<tr>
<th>Data</th>
<th>Scala</th>
<th>Piano</th>
<th>Lato</th>
<th>Nome</th>
<th>Temp</th>
<th>Tipo</th>
<th>Descrizione</th>
<th>Risolvi</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<!-- ======================
     CHAT DA GUALA
====================== -->
<div class="chat-section">
<h2>ðŸ’¬ Chat utenti â€“ Guala</h2>

<div id="chatListGuala">Caricamento chatâ€¦</div>

<div id="chatWindow" style="display:none">
<h3 id="chatTitle"></h3>
<div id="chatMessages"></div>
<textarea id="chatInput" placeholder="Scrivi risposta..."></textarea>
<button onclick="sendPartiComuniMsg()">Invia</button>
</div>
</div>

<!-- ======================
     CHAT DA PIOBESI
====================== -->
<div class="chat-section">
<h2>ðŸ’¬ Chat utenti â€“ Piobesi</h2>

<div id="chatListPiobesi">Caricamento chatâ€¦</div>
</div>

</div>

<script>
requireRole("particomuni");

/* =====================
   SEGNALAZIONI
===================== */
loadSegnalazioni(
 r => (r.tipo === "Parti comuni" || r.tipo === "particomuni") && r.stato === "attiva"
);

/* =====================
   CHAT 1â†”1
===================== */
let currentChatId = null;
let unsubscribeChat = null;

const chatWindow   = document.getElementById("chatWindow");
const chatMessages = document.getElementById("chatMessages");
const chatListGuala   = document.getElementById("chatListGuala");
const chatListPiobesi = document.getElementById("chatListPiobesi");

/* ===== LISTA CHAT GUALA ===== */
db.collection("chats")
.where("meta.destinatario","==","particomuni")
.where("meta.complesso","==","guala")
.orderBy("meta.nome")
.onSnapshot(snap=>{
  chatListGuala.innerHTML="";
  if(snap.empty){
    chatListGuala.innerText="Nessuna chat da Guala";
    return;
  }
  snap.forEach(doc=>{
    const d=doc.data();
    const b=document.createElement("button");
    b.innerText=`${d.meta.nome} â€“ ${d.meta.scala} ${d.meta.piano}`;
    b.onclick=()=>openChat(doc.id,d.meta);
    chatListGuala.appendChild(b);
  });
});

/* ===== LISTA CHAT PIOBESI ===== */
db.collection("chats")
.where("meta.destinatario","==","particomuni")
.where("meta.complesso","==","piobesi")
.orderBy("meta.nome")
.onSnapshot(snap=>{
  chatListPiobesi.innerHTML="";
  if(snap.empty){
    chatListPiobesi.innerText="Nessuna chat da Piobesi";
    return;
  }
  snap.forEach(doc=>{
    const d=doc.data();
    const b=document.createElement("button");
    b.innerText=`${d.meta.nome} â€“ ${d.meta.scala} ${d.meta.piano}`;
    b.onclick=()=>openChat(doc.id,d.meta);
    chatListPiobesi.appendChild(b);
  });
});

/* ===== APRI CHAT ===== */
function openChat(id,meta){
  currentChatId=id;
  chatWindow.style.display="block";
  document.getElementById("chatTitle").innerText =
   `${meta.nome} â€¢ ${meta.scala} ${meta.piano} ${meta.lato}`;

  if(unsubscribeChat) unsubscribeChat();

  unsubscribeChat = db.collection("chats")
   .doc(id).collection("messages")
   .orderBy("timestamp")
   .onSnapshot(s=>{
     chatMessages.innerHTML="";
     s.forEach(m=>{
       const d=m.data();
       const div=document.createElement("div");
       div.className="chat-msg "+d.mittente;
       div.innerText=d.testo;
       chatMessages.appendChild(div);
     });
   });
}

/* ===== INVIO RISPOSTA ===== */
function sendPartiComuniMsg(){
  const i=document.getElementById("chatInput");
  const t=i.value.trim();
  if(!t||!currentChatId) return;

  db.collection("chats")
   .doc(currentChatId)
   .collection("messages")
   .add({
     testo:t,
     mittente:"admin",
     timestamp:firebase.firestore.FieldValue.serverTimestamp()
   });

  i.value="";
}
</script>

</body>
</html>
