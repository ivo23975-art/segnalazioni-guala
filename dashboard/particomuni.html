<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Parti Comuni â€“ Chat Destinatario</title>

    <link rel="stylesheet" href="dashboard.css">

    <!-- FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <!-- CONFIG -->
    <script src="firebase-config.js"></script>

    <!-- AUTH -->
    <script src="admin-auth.js"></script>

    <style>
        .logout-btn {
            position: fixed;
            top: 12px;
            right: 20px;
            background: #ff4444;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            z-index: 9999;
        }

        .chat-admin-box {
            margin-top: 30px;
            border-top: 2px solid #333;
            padding-top: 20px;
        }

        .chat-list button {
            margin: 5px;
            padding: 6px 10px;
            cursor: pointer;
        }

        .chat-window {
            margin-top: 10px;
            border: 1px solid #333;
            padding: 10px;
            background: #111;
        }

        .chat-msg.admin { color: #00e676; }
        .chat-msg.user { color: #90caf9; }

        textarea {
            width: 100%;
            margin-top: 10px;
        }
    </style>
</head>

<body>

<a class="logout-btn" onclick="adminLogout()">Logout</a>

<div class="header">Parti Comuni â€“ Chat in arrivo</div>

<div class="content">

<!-- =======================
     CHAT DESTINATARIO
======================= -->
<div class="chat-admin-box">
    <h2>ðŸ’¬ Chat da Guala e Piobesi</h2>

    <div class="chat-list" id="chatList">Caricamento chatâ€¦</div>

    <div class="chat-window" id="chatWindow" style="display:none;">
        <h3 id="chatTitle"></h3>
        <div id="chatMessages"></div>
        <textarea id="chatInput" placeholder="Scrivi risposta..."></textarea>
        <button onclick="sendAdminMsg()">Invia</button>
    </div>
</div>

</div>

<script>
requireRole("particomuni");

/* =========================
   CHAT DESTINATARIO
========================= */

let currentChatId = null;
let unsubscribeChat = null;

const chatList = document.getElementById("chatList");
const chatWindow = document.getElementById("chatWindow");
const chatMessages = document.getElementById("chatMessages");

/* LISTA CHAT DESTINATE A PARTI COMUNI */
db.collection("chats")
  .where("meta.destinazione", "==", "particomuni")
  .orderBy("meta.nome")
  .onSnapshot(snap => {

    chatList.innerHTML = "";

    if (snap.empty) {
        chatList.innerText = "Nessuna chat attiva";
        return;
    }

    snap.forEach(doc => {
        const d = doc.data();
        const btn = document.createElement("button");

        btn.innerText =
            `[${d.meta.origine.toUpperCase()}] ${d.meta.nome}`;

        btn.onclick = () => openChat(doc.id, d.meta);

        chatList.appendChild(btn);
    });
});

/* APERTURA CHAT */
function openChat(id, meta) {

    currentChatId = id;
    chatWindow.style.display = "block";

    document.getElementById("chatTitle").innerText =
        `${meta.nome} â€“ ${meta.scala} ${meta.piano} ${meta.lato} (${meta.origine})`;

    if (unsubscribeChat) unsubscribeChat();

    unsubscribeChat = db.collection("chats")
        .doc(id)
        .collection("messages")
        .orderBy("timestamp")
        .onSnapshot(snap => {

            chatMessages.innerHTML = "";

            snap.forEach(m => {
                const msg = m.data();
                const div = document.createElement("div");
                div.className = "chat-msg " + msg.mittente;
                div.innerText = msg.testo;
                chatMessages.appendChild(div);
            });

            chatMessages.scrollTop = chatMessages.scrollHeight;
        });
}

/* INVIO MESSAGGIO PARTI COMUNI */
function sendAdminMsg() {

    const input = document.getElementById("chatInput");
    const text = input.value.trim();

    if (!text || !currentChatId) return;

    db.collection("chats")
      .doc(currentChatId)
      .collection("messages")
      .add({
          testo: text,
          mittente: "admin",
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });

    input.value = "";
}
</script>

</body>
</html>
