<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Piobesi â€“ Segnalazioni attive</title>

  <link rel="stylesheet" href="dashboard.css">
  <link rel="icon" href="data:,">

  <!-- FIREBASE -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <!-- CONFIG -->
  <script src="firebase-config.js"></script>

  <!-- AUTH -->
  <script src="admin-auth.js"></script>

  <!-- DASHBOARD -->
  <script src="dashboard.js"></script>

  <style>
    .logout-btn{
      position:fixed;
      top:12px;
      right:20px;
      background:#ff4444;
      color:white;
      padding:8px 16px;
      border-radius:8px;
      font-weight:bold;
      cursor:pointer;
      z-index:9999;
    }

    .section{margin-bottom:18px}

    /* ===== CHAT CARD ===== */
    .chat-card{
      background:#0f2a3d;
      border-radius:12px;
      padding:12px;
      box-shadow:0 4px 14px rgba(0,0,0,.18);
      color:#fff;
      border:1px solid rgba(255,255,255,.08);
    }

    .chat-card.attn{
      animation:blink 1.2s infinite;
      border-color:rgba(255,204,0,.6);
    }
    @keyframes blink{
      0%,100%{filter:brightness(1)}
      50%{filter:brightness(1.25)}
    }

    .chat-card-head{
      display:flex;
      justify-content:space-between;
      cursor:pointer;
      font-weight:900;
    }

    .chat-list{
      display:none;
      margin-top:10px;
      max-height:320px;
      overflow-y:auto;
    }

    .chat-item{
      background:#102f45;
      border-radius:10px;
      padding:10px;
      margin-bottom:8px;
      cursor:pointer;
      border:1px solid rgba(255,255,255,.06);
    }
    .chat-item:hover{background:#123e5c}

    .chat-item.unread{
      animation:pulse 1.2s infinite;
      border-color:#ffcc00;
    }
    @keyframes pulse{
      0%,100%{transform:scale(1)}
      50%{transform:scale(1.02)}
    }

    .chat-title{font-weight:900}
    .chat-meta{font-size:12px;opacity:.85}

    /* ===== MODALE ===== */
    .modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.45);
      display:none;
      justify-content:center;
      align-items:center;
      z-index:9999;
    }
    .modal-content{
      background:white;
      width:92%;
      max-width:520px;
      height:78vh;
      border-radius:16px;
      padding:14px;
      display:flex;
      flex-direction:column;
    }
    #chatTitle,#chatDocHint{color:#000;text-align:center}
    #chatMessages{
      flex:1;
      overflow-y:auto;
      border:1px solid #ddd;
      border-radius:12px;
      padding:10px;
      background:#fafafa;
      margin-top:10px;
    }
    .bubble{
      max-width:80%;
      padding:8px 10px;
      border-radius:12px;
      margin:6px 0;
      color:#000;
    }
    .user{background:#e6f2ff;align-self:flex-start}
    .admin{background:#d6ffd6;align-self:flex-end}

    textarea{
      width:100%;
      height:70px;
      border-radius:12px;
      padding:10px;
      color:#000;
    }
    .btn{
      margin-top:8px;
      padding:12px;
      border:none;
      border-radius:12px;
      font-weight:900;
      cursor:pointer;
    }
    .send{background:#00c853}
    .close{background:#ccc}
  </style>
</head>

<body>

<a class="logout-btn" onclick="adminLogout()">Logout</a>

<div class="header">Piobesi â€“ Segnalazioni attive</div>

<div class="content">

  <!-- CHAT -->
  <div class="section">
    <div class="chat-card" id="card">
      <div class="chat-card-head" onclick="toggleChat()">
        <div>ðŸ’¬ Chat Piobesi</div>
        <div id="chev">â–¸</div>
      </div>
      <div class="chat-list" id="chatList">Caricamentoâ€¦</div>
    </div>
  </div>

  <!-- SEGNALAZIONI (INVARIATE) -->
  <table class="table">
    <thead>
      <tr>
        <th>Data</th><th>Scala</th><th>Piano</th><th>Lato</th>
        <th>Nome</th><th>Temp</th><th>Tipo</th><th>Descrizione</th><th>Azioni</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

</div>

<!-- MODALE -->
<div class="modal" id="modal">
  <div class="modal-content">
    <h3 id="chatTitle"></h3>
    <div id="chatDocHint"></div>
    <div id="chatMessages"></div>
    <textarea id="chatInput"></textarea>
    <button class="btn send" onclick="sendMsg()">Invia</button>
    <button class="btn close" onclick="closeChat()">Chiudi</button>
  </div>
</div>

<script>
requireRole("piobesi");
loadSegnalazioni(r=>r.stato==="attiva" && r.complesso==="piobesi");

const db=firebase.firestore();
const chatList=document.getElementById("chatList");
const modal=document.getElementById("modal");
const msgs=document.getElementById("chatMessages");
const input=document.getElementById("chatInput");
const title=document.getElementById("chatTitle");
const hint=document.getElementById("chatDocHint");
const card=document.getElementById("card");

let openId=null, unsub=null;

function toggleChat(){
  chatList.style.display = chatList.style.display==="block"?"none":"block";
  document.getElementById("chev").innerText = chatList.style.display==="block"?"â–¾":"â–¸";
}

db.collection("chats")
  .where("meta.complesso","==","piobesi")
  .onSnapshot(s=>{
    chatList.innerHTML="";
    card.classList.remove("attn");
    s.forEach(d=>{
      const m=d.data().meta||{};
      const div=document.createElement("div");
      div.className="chat-item";
      div.innerHTML=`<div class="chat-title">${m.nome||""}</div>
                     <div class="chat-meta">${m.scala||""} ${m.piano||""} ${m.lato||""}</div>`;
      div.onclick=()=>openChat(d.id,m);
      chatList.appendChild(div);
      card.classList.add("attn");
    });
    if(!s.size) chatList.innerText="Nessuna chat";
  });

function openChat(id,m){
  openId=id;
  modal.style.display="flex";
  msgs.innerHTML="";
  title.innerText=`Chat â€¢ ${m.nome||""}`;
  hint.innerText=`Documento: ${id}`;
  card.classList.remove("attn");

  if(unsub) unsub();
  unsub=db.collection("chats").doc(id).collection("messages")
    .orderBy("timestamp")
    .onSnapshot(s=>{
      msgs.innerHTML="";
      s.forEach(d=>{
        const b=document.createElement("div");
        b.className="bubble "+(d.data().mittente==="admin"?"admin":"user");
        b.innerText=d.data().testo;
        msgs.appendChild(b);
      });
      msgs.scrollTop=msgs.scrollHeight;
    });
}

function closeChat(){
  modal.style.display="none";
  if(unsub) unsub();
  unsub=null;
  openId=null;
}

function sendMsg(){
  if(!openId || !input.value.trim()) return;
  db.collection("chats").doc(openId).collection("messages").add({
    testo:input.value,
    mittente:"admin",
    timestamp:firebase.firestore.FieldValue.serverTimestamp()
  });
  input.value="";
}
</script>

</body>
</html>
