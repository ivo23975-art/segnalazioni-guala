<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Piobesi â€“ Segnalazioni attive</title>

  <link rel="stylesheet" href="dashboard.css">
  <link rel="icon" href="data:,">

  <!-- FIREBASE -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <!-- CONFIG -->
  <script src="firebase-config-dashboard.js"></script>


  <!-- AUTH -->
  <script src="admin-auth.js"></script>

  <!-- DASHBOARD -->
  <script src="dashboard.js"></script>

  <style>
    .logout-btn {
      position: fixed;
      top: 12px;
      right: 20px;
      background: #ff4444;
      color: white;
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      z-index: 9999;
    }

    /* ===== CHAT â€“ 1 CARD SOPRA SEGNALAZIONI ===== */
    .section { margin-bottom: 18px; }

    .chat-card{
      background:#0f2a3d;
      border-radius:12px;
      padding:12px;
      box-shadow: 0 4px 14px rgba(0,0,0,0.18);
      color:#fff;
      border: 1px solid rgba(255,255,255,0.08);
      transform: translateZ(0);
    }

    /* lampeggio contenitore (giallo) quando arrivano nuovi messaggi */
    .chat-card.attn{
      animation: cardBlinkYellow 1.2s infinite;
      border-color: rgba(255,204,0,0.65);
      box-shadow: 0 8px 24px rgba(255,204,0,0.25), 0 4px 14px rgba(0,0,0,0.18);
    }
    @keyframes cardBlinkYellow{
      0%,100%{ filter: brightness(1); }
      50%{ filter: brightness(1.25); }
    }

    .chat-card-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      cursor:pointer;
      user-select:none;
      font-weight:900;
      letter-spacing:.2px;
    }

    .chat-card-sub{
      color: rgba(255,255,255,0.82);
      margin-top:6px;
      font-size:13px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
    }

    .card-unread-pill{
      display:none;
      font-size:12px;
      font-weight:900;
      padding:4px 10px;
      border-radius:999px;
      background: rgba(255,204,0,0.18);
      border: 1px solid rgba(255,204,0,0.45);
      color:#fff;
      white-space:nowrap;
    }

    .chat-list{
      margin-top:10px;
      display:none;
      max-height:320px;
      overflow-y:auto;
      padding-right:4px;
    }

    .chat-item{
      background:#102f45;
      border-radius:10px;
      padding:10px 10px;
      margin-bottom:8px;
      cursor:pointer;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      border: 1px solid rgba(255,255,255,0.06);
      transform: translateZ(0);
    }
    .chat-item:hover{ background:#123e5c; }

    .chat-item .left{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .chat-item .title{
      color:#ffffff;
      font-weight:900;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .chat-item .meta{
      color: rgba(255,255,255,0.85);
      font-size:12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .badges{
      display:flex;
      align-items:center;
      gap:8px;
      flex-shrink:0;
    }
    .badge{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      font-weight:900;
      white-space:nowrap;
    }
    .badge-admin{ background:#0077ff; color:#fff; }
    .badge-pc{ background:#ffcc00; color:#111; }

    /* ===== unread badge + effetto wow ===== */
    .badge-unread{
      display:none;
      border:1px solid rgba(0,0,0,0.15);
      box-shadow: 0 6px 14px rgba(0,0,0,0.18);
      transform: perspective(600px) rotateX(6deg);
    }

    .chat-item.unread-green{
      border-color: rgba(0,200,83,0.35);
      box-shadow: 0 10px 26px rgba(0,200,83,0.10), 0 4px 14px rgba(0,0,0,0.18);
      animation: wowPulse 1.6s infinite;
    }
    .chat-item.unread-orange{
      border-color: rgba(255,136,0,0.45);
      box-shadow: 0 12px 28px rgba(255,136,0,0.18), 0 4px 14px rgba(0,0,0,0.18);
      animation: wowPulse 1.2s infinite;
    }
    .chat-item.unread-red{
      border-color: rgba(213,0,0,0.55);
      box-shadow: 0 14px 32px rgba(213,0,0,0.22), 0 4px 14px rgba(0,0,0,0.18);
      animation: wowPulse 0.9s infinite;
    }

    @keyframes wowPulse{
      0%,100%{ transform: translateZ(0) scale(1); filter: brightness(1); }
      50%{ transform: translateZ(0) scale(1.012); filter: brightness(1.18); }
    }

    .badge-unread.green{ background:#00c853; color:#081b10; }
    .badge-unread.orange{ background:#ff8800; color:#111; }
    .badge-unread.red{ background:#d50000; color:#fff; }

    /* ===== MODALE CHAT ===== */
    .modal{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.45);
      display:none;
      justify-content:center;
      align-items:center;
      z-index:9999;
    }
    .modal-content{
      background:white;
      width:92%;
      max-width:520px;
      height:78vh;
      max-height:78vh;
      border-radius:16px;
      padding:14px;
      display:flex;
      flex-direction:column;
    }
    #chatTitle{
      margin:0;
      text-align:center;
      font-weight:900;
      color:#000;
    }
    #chatDocHint{
      margin-top:6px;
      font-size:12px;
      opacity:.75;
      text-align:center;
      color:#000;
    }
    #chatMessages{
      flex:1;
      overflow-y:auto;
      border:1px solid #e2e2e2;
      border-radius:12px;
      padding:10px;
      background:#fafafa;
      margin-top:10px;
    }
    .chat-bubble{
      max-width:82%;
      padding:.6rem .75rem;
      border-radius:.9rem;
      margin:.35rem 0;
      display:inline-flex;
      flex-direction:column;
      gap:.25rem;
      box-shadow:0 2px 10px rgba(0,0,0,.08);
      word-wrap:break-word;
      white-space:pre-wrap;
      color:#000;
    }
    .chat-bubble-user{
      background:#e6f2ff;
      align-self:flex-start;
      margin-right:auto;
    }
    .chat-bubble-admin{
      background:#d6ffd6;
      align-self:flex-end;
      margin-left:auto;
    }
    .chat-time{
      font-size:.75rem;
      opacity:.65;
      text-align:right;
      color:#000;
    }

    textarea{
      width:100%;
      height:70px;
      resize:none;
      border:1px solid #ccc;
      border-radius:12px;
      padding:10px;
      margin-top:10px;
      box-sizing:border-box;
      color:#000;
    }
    .btn{
      margin-top:10px;
      padding:12px;
      width:100%;
      border:none;
      border-radius:12px;
      cursor:pointer;
      font-weight:900;
    }
    .btnSend{ background:#00c853; color:#111; }
    .btnClose{ background:#ccc; color:#111; }
  </style>
</head>

<body>

<a class="logout-btn" onclick="adminLogout()">Logout</a>

<div class="header">Piobesi â€“ Segnalazioni attive</div>

<div class="content">

  <!-- ================= CHAT (SOPRA SEGNALAZIONI) ================= -->
  <div class="section">
    <div class="chat-card" id="cardPiobesi">
      <div class="chat-card-head" onclick="piobesi_toggleChatCard()">
        <div>ðŸ’¬ Chat Piobesi</div>
        <div id="chevPiobesi">â–¸</div>
      </div>
      <div class="chat-card-sub">
        <span>Chat del complesso Piobesi (amministrazione + parti comuni).</span>
        <span class="card-unread-pill" id="pillPiobesi">Nuovi: 0</span>
      </div>
      <div class="chat-list" id="listPiobesi">Caricamento chatâ€¦</div>
    </div>
  </div>

  <!-- =======================
       SEGNALAZIONI (INVARIATE)
  ======================= -->
  <table class="table">
    <thead>
      <tr>
        <th>Data</th>
        <th>Scala</th>
        <th>Piano</th>
        <th>Lato</th>
        <th>Nome</th>
        <th>Temp</th>
        <th>Tipo</th>
        <th>Descrizione</th>
        <th>Azioni</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

</div>

<!-- ================= MODALE CHAT ================= -->
<div class="modal" id="modalChatPiobesi">
  <div class="modal-content">
    <h3 id="chatTitle"></h3>
    <div id="chatDocHint"></div>
    <div id="chatMessages"></div>
    <textarea id="chatInput" placeholder="Scrivi come admin..."></textarea>
    <button class="btn btnSend" onclick="piobesi_sendAdminMessage()">Invia</button>
    <button class="btn btnClose" onclick="piobesi_closeChatModal()">Chiudi</button>
  </div>
</div>

<script>
requireRole("piobesi");

/* SEGNALAZIONI */
loadSegnalazioni(r => r.stato === "attiva" && r.complesso === "piobesi");

/* ===== CHAT PIOBESI ===== */
const fdb = (window.db && window.db.collection) ? window.db : firebase.firestore();

const piobesi_list = document.getElementById("listPiobesi");
const piobesi_card = document.getElementById("cardPiobesi");
const piobesi_pill = document.getElementById("pillPiobesi");

const piobesi_modalChat = document.getElementById("modalChatPiobesi");
const piobesi_chatTitle = document.getElementById("chatTitle");
const piobesi_chatDocHint = document.getElementById("chatDocHint");
const piobesi_chatMessages = document.getElementById("chatMessages");
const piobesi_chatInput = document.getElementById("chatInput");

let piobesi_chatOpenDocId = null;
let piobesi_chatOpenMeta = null;
let piobesi_unsubscribeOpenChat = null;

const piobesi_perChatListener = new Map();  // docId -> unsubscribe
const piobesi_perChatUnread = new Map();    // docId -> unreadCount
const piobesi_perChatLastSeen = new Map();  // docId -> lastReadMs
let piobesi_renderCache = [];

function piobesi_toggleChatCard(){
  const open = piobesi_list.style.display === "block";
  piobesi_list.style.display = open ? "none" : "block";
  document.getElementById("chevPiobesi").innerText = open ? "â–¸" : "â–¾";
}

function piobesi_safeStr(v){ return (v === null || v === undefined) ? "" : String(v); }
function piobesi_toLower(v){ return piobesi_safeStr(v).toLowerCase(); }

function piobesi_buildVisualKey(meta){
  const destinatario = piobesi_toLower(meta.destinatario);
  const scala = piobesi_toLower(meta.scala);
  const piano = piobesi_toLower(meta.piano);
  const lato = piobesi_toLower(meta.lato);
  const nome = piobesi_toLower(meta.nome);
  return `${destinatario}||${scala}||${piano}||${lato}||${nome}`;
}

function piobesi_pickTimestamp(meta){
  try{
    if (meta && meta.createdAt && meta.createdAt.toMillis) return meta.createdAt.toMillis();
    if (meta && meta.pinSetAt && meta.pinSetAt.toMillis) return meta.pinSetAt.toMillis();
  }catch(e){}
  return 0;
}

function piobesi_getUnreadClass(n){
  if (!n || n <= 0) return { cls:"", badge:"", color:"" };
  if (n <= 2) return { cls:"unread-green", badge:`Nuovi ${n}`, color:"green" };
  if (n <= 6) return { cls:"unread-orange", badge:`Nuovi ${n}`, color:"orange" };
  return { cls:"unread-red", badge:`Nuovi ${n}`, color:"red" };
}

function piobesi_updateContainerIndicators(){
  let tot = 0;
  piobesi_renderCache.forEach(it => { tot += (piobesi_perChatUnread.get(it.docId) || 0); });

  if (tot > 0) piobesi_card.classList.add("attn"); else piobesi_card.classList.remove("attn");

  if (tot > 0){
    piobesi_pill.style.display = "inline-flex";
    piobesi_pill.innerText = `Nuovi: ${tot}`;
  } else {
    piobesi_pill.style.display = "none";
  }
}

function piobesi_ensurePerChatUnreadListener(docId){
  if (piobesi_perChatListener.has(docId)) return;

  const unsub = fdb.collection("chats").doc(docId)
    .collection("messages")
    .orderBy("timestamp","desc")
    .limit(50)
    .onSnapshot((snap)=>{
      fdb.collection("chats").doc(docId).get().then((chatSnap)=>{
        let lastReadMs = 0;
        const data = chatSnap.exists ? (chatSnap.data() || {}) : {};
        const meta = data.meta || {};
        try{
          if (meta.lastReadAdminAt && meta.lastReadAdminAt.toMillis) lastReadMs = meta.lastReadAdminAt.toMillis();
        }catch(e){ lastReadMs = 0; }

        const localSeen = piobesi_perChatLastSeen.get(docId);
        if (localSeen && localSeen > lastReadMs) lastReadMs = localSeen;

        let unread = 0;
        snap.forEach((d)=>{
          const m = d.data() || {};
          if (m.mittente !== "user") return;
          let tms = 0;
          try{
            if (m.timestamp && m.timestamp.toMillis) tms = m.timestamp.toMillis();
            else if (m.timestamp && m.timestamp.toDate) tms = m.timestamp.toDate().getTime();
          }catch(e){ tms = 0; }
          if (tms > lastReadMs) unread += 1;
        });

        if (piobesi_chatOpenDocId && piobesi_chatOpenDocId === docId && piobesi_modalChat.style.display === "flex"){
          unread = 0;
        }

        piobesi_perChatUnread.set(docId, unread);
        piobesi_renderChatList(piobesi_list, piobesi_renderCache);
        piobesi_updateContainerIndicators();
      }).catch(()=>{
        piobesi_perChatUnread.set(docId, piobesi_perChatUnread.get(docId) || 0);
        piobesi_renderChatList(piobesi_list, piobesi_renderCache);
        piobesi_updateContainerIndicators();
      });
    });

  piobesi_perChatListener.set(docId, unsub);
}

function piobesi_cleanupPerChatListeners(currentIdsSet){
  for (const [docId, unsub] of piobesi_perChatListener.entries()){
    if (!currentIdsSet.has(docId)){
      try{ unsub(); }catch(e){}
      piobesi_perChatListener.delete(docId);
      piobesi_perChatUnread.delete(docId);
      piobesi_perChatLastSeen.delete(docId);
    }
  }
}

function piobesi_renderChatList(targetEl, rows){
  targetEl.innerHTML = "";
  if (!rows.length){
    targetEl.innerText = "Nessuna chat";
    return;
  }

  rows.sort((a,b)=>{
    const an = (a.meta && a.meta.nome) ? a.meta.nome.toLowerCase() : "";
    const bn = (b.meta && b.meta.nome) ? b.meta.nome.toLowerCase() : "";
    if (an < bn) return -1;
    if (an > bn) return 1;
    return 0;
  });

  rows.forEach(item=>{
    const m = item.meta || {};
    const row = document.createElement("div");
    row.className = "chat-item";

    const destIsPC = (piobesi_toLower(m.destinatario) === "particomuni");
    const destLabel = destIsPC ? "PARTI COMUNI" : "AMMIN.";
    const badgeClass = destIsPC ? "badge-pc" : "badge-admin";

    const titolo = piobesi_safeStr(m.nome);
    const metaLine = `${piobesi_safeStr(m.scala)} â€¢ ${piobesi_safeStr(m.piano)} â€¢ ${piobesi_safeStr(m.lato)}`;

    const unreadCount = piobesi_perChatUnread.get(item.docId) || 0;
    const u = piobesi_getUnreadClass(unreadCount);

    if (unreadCount > 0) row.classList.add(u.cls);

    row.innerHTML = `
      <div class="left">
        <div class="title">${titolo}</div>
        <div class="meta">${metaLine}</div>
      </div>
      <div class="badges">
        <div class="badge badge-unread ${u.color}" style="${unreadCount>0?'display:inline-flex':'display:none'}">${u.badge || ""}</div>
        <div class="badge ${badgeClass}">${destLabel}</div>
      </div>
    `;

    row.onclick = () => piobesi_openChatByDocId(item.docId, m);
    targetEl.appendChild(row);
  });
}

function piobesi_markChatRead(docId){
  piobesi_perChatLastSeen.set(docId, Date.now());
  fdb.collection("chats").doc(docId).update({
    "meta.lastReadAdminAt": firebase.firestore.FieldValue.serverTimestamp()
  }).catch(()=>{});
  piobesi_perChatUnread.set(docId, 0);
}

function piobesi_openChatByDocId(docId, meta){
  piobesi_chatOpenDocId = docId;
  piobesi_chatOpenMeta = meta || {};

  const titoloDest = (piobesi_toLower(meta.destinatario) === "particomuni") ? "Parti Comuni" : "Amministrazione";
  piobesi_chatTitle.innerText = `Chat â€¢ ${titoloDest} â€¢ ${piobesi_safeStr(meta.nome)} â€¢ ${piobesi_safeStr(meta.scala)} â€¢ ${piobesi_safeStr(meta.piano)} â€¢ ${piobesi_safeStr(meta.lato)}`;
  piobesi_chatDocHint.innerText = `Documento chat: ${docId}`;

  piobesi_modalChat.style.display = "flex";
  piobesi_chatMessages.innerHTML = "";

  piobesi_markChatRead(docId);
  piobesi_updateContainerIndicators();

  if (piobesi_unsubscribeOpenChat) piobesi_unsubscribeOpenChat();

  piobesi_unsubscribeOpenChat = fdb.collection("chats").doc(docId)
    .collection("messages")
    .orderBy("timestamp","asc")
    .onSnapshot((s)=>{
      piobesi_chatMessages.innerHTML = "";
      s.forEach((d)=>{
        const mm = d.data() || {};
        const bubble = document.createElement("div");
        bubble.className = "chat-bubble " + (mm.mittente === "admin" ? "chat-bubble-admin" : "chat-bubble-user");

        const textDiv = document.createElement("div");
        textDiv.innerText = piobesi_safeStr(mm.testo);

        const timeDiv = document.createElement("div");
        timeDiv.className = "chat-time";
        if (mm.timestamp && mm.timestamp.toDate) {
          timeDiv.innerText = mm.timestamp.toDate().toLocaleTimeString("it-IT", { hour:"2-digit", minute:"2-digit" });
        } else {
          timeDiv.innerText = "";
        }

        bubble.appendChild(textDiv);
        bubble.appendChild(timeDiv);
        piobesi_chatMessages.appendChild(bubble);
      });

      piobesi_chatMessages.scrollTop = piobesi_chatMessages.scrollHeight;

      if (piobesi_chatOpenDocId === docId){
        piobesi_markChatRead(docId);
        piobesi_updateContainerIndicators();
      }
    }, (err)=>{
      alert("Errore lettura chat: " + err.message);
    });
}

function piobesi_closeChatModal(){
  piobesi_modalChat.style.display = "none";
  piobesi_chatInput.value = "";
  piobesi_chatMessages.innerHTML = "";
  piobesi_chatOpenDocId = null;
  piobesi_chatOpenMeta = null;
  if (piobesi_unsubscribeOpenChat) piobesi_unsubscribeOpenChat();
  piobesi_unsubscribeOpenChat = null;
  piobesi_updateContainerIndicators();
}

function piobesi_sendAdminMessage(){
  const text = (piobesi_chatInput.value || "").trim();
  if (!text) return;
  if (!piobesi_chatOpenDocId) return;

  fdb.collection("chats").doc(piobesi_chatOpenDocId)
    .collection("messages")
    .add({
      testo: text,
      mittente: "admin",
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    })
    .then(()=>{
      piobesi_chatInput.value = "";
      piobesi_markChatRead(piobesi_chatOpenDocId);
      piobesi_updateContainerIndicators();
    })
    .catch((err)=>{
      alert("Errore invio: " + err.message);
    });
}

/* ===== INDICE CHAT: SOLO complesso piobesi, destinatario amm/pc ===== */
fdb.collection("chats")
  .where("meta.complesso","==","piobesi")
  .onSnapshot((snap)=>{
    const map = new Map();
    const currentIds = new Set();

    snap.forEach(doc=>{
      const d = doc.data() || {};
      const m = d.meta || {};

      const dest = piobesi_toLower(m.destinatario);
      if (dest !== "amministrazione" && dest !== "particomuni") return;

      currentIds.add(doc.id);
      piobesi_ensurePerChatUnreadListener(doc.id);

      const visualKey = piobesi_buildVisualKey(m);
      const ts = piobesi_pickTimestamp(m);

      if (!map.has(visualKey)){
        map.set(visualKey, { docId: doc.id, meta: m, bestTs: ts });
      } else {
        const existing = map.get(visualKey);
        if (ts > (existing.bestTs || 0)){
          existing.docId = doc.id;
          existing.meta = m;
          existing.bestTs = ts;
        }
        map.set(visualKey, existing);
      }
    });

    piobesi_cleanupPerChatListeners(currentIds);

    piobesi_renderCache = Array.from(map.values());
    piobesi_renderChatList(piobesi_list, piobesi_renderCache);
    piobesi_updateContainerIndicators();
  }, (err)=>{
    alert("Errore indice chat: " + err.message);
  });
</script>

</body>
</html>
