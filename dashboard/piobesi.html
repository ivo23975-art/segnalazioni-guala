<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Piobesi â€“ Segnalazioni + Chat</title>

<link rel="stylesheet" href="dashboard.css">

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<!-- CONFIG -->
<script src="firebase-config.js"></script>
<script src="admin-auth.js"></script>
<script src="dashboard.js"></script>

<style>
.logout-btn{
  position:fixed;top:12px;right:20px;
  background:#ff4444;color:#fff;
  padding:8px 16px;border-radius:8px;
  font-weight:bold;cursor:pointer;z-index:9999;
}

.section{margin-bottom:30px}

/* ===== CHAT CARD ===== */
.chat-card{
  background:#0f2a3d;
  border-radius:12px;
  padding:14px;
  margin-bottom:20px;
  color:#fff;
  border:1px solid rgba(255,255,255,0.1);
}

.chat-card.attn{
  animation: blink 1.2s infinite;
  border-color:#ffcc00;
}
@keyframes blink{
  0%,100%{filter:brightness(1)}
  50%{filter:brightness(1.25)}
}

.chat-list{
  margin-top:10px;
  max-height:280px;
  overflow-y:auto;
}

.chat-item{
  background:#102f45;
  padding:10px;
  border-radius:8px;
  margin-bottom:8px;
  cursor:pointer;
}
.chat-item:hover{background:#123e5c}

/* ===== MODALE CHAT ===== */
.modal{
  position:fixed;inset:0;
  background:rgba(0,0,0,.45);
  display:none;justify-content:center;align-items:center;
  z-index:9999;
}
.modal-content{
  background:#fff;
  width:92%;max-width:520px;
  height:78vh;
  border-radius:16px;
  padding:14px;
  display:flex;flex-direction:column;
}

#chatMessages{
  flex:1;
  overflow-y:auto;
  border:1px solid #ddd;
  border-radius:12px;
  padding:10px;
  background:#fafafa;
  margin-top:10px;
}

.chat-bubble{
  max-width:80%;
  padding:8px 10px;
  border-radius:10px;
  margin:6px 0;
  color:#000;
}
.chat-user{background:#e6f2ff}
.chat-admin{background:#d6ffd6;margin-left:auto}

textarea{
  width:100%;height:70px;
  border-radius:10px;
  padding:10px;
  margin-top:10px;
  color:#000;
}

.btn{
  margin-top:10px;
  padding:10px;
  border-radius:10px;
  border:none;
  font-weight:bold;
  cursor:pointer;
}
.btnSend{background:#00c853}
.btnClose{background:#ccc}
</style>
</head>

<body>

<a class="logout-btn" onclick="adminLogout()">Logout</a>

<div class="header">Piobesi â€“ Segnalazioni attive</div>

<div class="content">

<!-- ===== CHAT ===== -->
<div class="section">
  <h2>ðŸ’¬ Chat utenti â€“ Piobesi</h2>

  <div class="chat-card" id="chatCard">
    <div class="chat-list" id="chatList">Caricamentoâ€¦</div>
  </div>
</div>

<!-- ===== SEGNALAZIONI (INALTERATE) ===== -->
<div class="section">
<table class="table">
<thead>
<tr>
<th>Data</th><th>Scala</th><th>Piano</th><th>Lato</th>
<th>Nome</th><th>Temp</th><th>Tipo</th><th>Descrizione</th><th>Azioni</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

</div>

<!-- ===== MODALE CHAT ===== -->
<div class="modal" id="chatModal">
  <div class="modal-content">
    <h3 id="chatTitle"></h3>
    <div id="chatMessages"></div>
    <textarea id="chatInput" placeholder="Scrivi risposta..."></textarea>
    <button class="btn btnSend" onclick="sendMsg()">Invia</button>
    <button class="btn btnClose" onclick="closeChat()">Chiudi</button>
  </div>
</div>

<script>
requireRole("piobesi");

/* SEGNALAZIONI */
loadSegnalazioni(r=>r.stato==="attiva" && r.complesso==="piobesi");

const dbi = firebase.firestore();
const chatList = document.getElementById("chatList");
const chatCard = document.getElementById("chatCard");
const chatModal = document.getElementById("chatModal");
const chatMessages = document.getElementById("chatMessages");

let currentChatId = null;
let unsubMessages = null;
let hasUnread = false;

/* ===== LISTA CHAT (UNA SOLA PER UNITÃ€) ===== */
dbi.collection("chats")
.where("meta.complesso","==","piobesi")
.onSnapshot(snap=>{
  chatList.innerHTML="";
  hasUnread = false;

  snap.forEach(doc=>{
    const m = doc.data().meta || {};
    const div = document.createElement("div");
    div.className="chat-item";
    div.innerText=`${m.nome || ""} â€“ ${m.scala || ""} ${m.piano || ""} ${m.lato || ""}`;
    div.onclick=()=>openChat(doc.id,m);
    chatList.appendChild(div);

    listenUnread(doc.id);
  });

  if(hasUnread) chatCard.classList.add("attn");
  else chatCard.classList.remove("attn");
});

/* ===== UNREAD LOGIC (DEFINITIVA) ===== */
function listenUnread(id){
  dbi.collection("chats").doc(id)
  .collection("messages")
  .orderBy("timestamp","desc")
  .limit(1)
  .onSnapshot(s=>{
    s.forEach(d=>{
      if(d.data().mittente==="user" && id!==currentChatId){
        hasUnread=true;
        chatCard.classList.add("attn");
      }
    });
  });
}

/* ===== APRI CHAT ===== */
function openChat(id,meta){
  currentChatId=id;
  hasUnread=false;
  chatCard.classList.remove("attn");

  document.getElementById("chatTitle").innerText=
    `${meta.nome} â€“ ${meta.scala} ${meta.piano} ${meta.lato}`;

  chatModal.style.display="flex";
  chatMessages.innerHTML="";

  if(unsubMessages) unsubMessages();

  unsubMessages=dbi.collection("chats")
    .doc(id).collection("messages")
    .orderBy("timestamp")
    .onSnapshot(s=>{
      chatMessages.innerHTML="";
      s.forEach(m=>{
        const d=m.data();
        const div=document.createElement("div");
        div.className="chat-bubble "+(d.mittente==="admin"?"chat-admin":"chat-user");
        div.innerText=d.testo;
        chatMessages.appendChild(div);
      });
      chatMessages.scrollTop=chatMessages.scrollHeight;
    });
}

/* ===== INVIO ===== */
function sendMsg(){
  const txt=document.getElementById("chatInput").value.trim();
  if(!txt||!currentChatId)return;

  dbi.collection("chats").doc(currentChatId)
    .collection("messages")
    .add({
      testo:txt,
      mittente:"admin",
      timestamp:firebase.firestore.FieldValue.serverTimestamp()
    });

  document.getElementById("chatInput").value="";
}

/* ===== CHIUDI ===== */
function closeChat(){
  chatModal.style.display="none";
  currentChatId=null;
  if(unsubMessages) unsubMessages();
}
</script>

</body>
</html>
