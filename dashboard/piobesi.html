<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Piobesi â€“ Segnalazioni attive</title>

    <link rel="stylesheet" href="dashboard.css">

    <!-- FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <!-- CONFIG -->
    <script src="firebase-config.js"></script>

    <!-- AUTH -->
    <script src="admin-auth.js"></script>

    <!-- DASHBOARD CORE (NO CHAT) -->
    <script src="dashboard.js"></script>

    <style>
        .logout-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            background: #ff0000;
            color: white;
            padding: 10px 18px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none;
            transition: 0.2s;
            z-index: 9999;
        }
        .logout-btn:hover { background: #cc0000; }

        .chat-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .chat-window {
            background: #0e1b2a;
            width: 420px;
            max-width: 95%;
            border-radius: 12px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            color: white;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin: 10px 0;
            padding: 8px;
            background: #07121f;
            border-radius: 8px;
        }

        .chat-bubble {
            margin-bottom: 6px;
            padding: 6px 10px;
            border-radius: 10px;
            font-size: 14px;
            max-width: 80%;
        }

        .chat-user { background:#1976d2; align-self:flex-start; }
        .chat-admin { background:#2e7d32; align-self:flex-end; }

        .chat-input {
            width: 100%;
            resize: none;
            height: 60px;
            border-radius: 8px;
            padding: 6px;
        }

        .chat-buttons {
            display:flex;
            gap:8px;
            margin-top:6px;
        }

        .chat-buttons button {
            flex:1;
            padding:6px;
            font-weight:bold;
            cursor:pointer;
        }
    </style>
</head>

<body>

<a class="logout-btn" onclick="adminLogout()">Logout</a>

<div class="header">Piobesi â€“ Segnalazioni attive</div>

<div class="content">
<table class="table">
<thead>
<tr>
    <th>Data</th>
    <th>Scala</th>
    <th>Piano</th>
    <th>Lato</th>
    <th>Nome</th>
    <th>Temp</th>
    <th>Tipo</th>
    <th>Descrizione</th>
    <th>Azioni</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

<!-- ================= CHAT POPUP ================= -->
<div id="chatPopup" class="chat-overlay">
    <div class="chat-window">
        <h3 id="chatTitle">Chat</h3>
        <div id="chatMessages" class="chat-messages"></div>
        <textarea id="chatInput" class="chat-input" placeholder="Scrivi messaggio..."></textarea>
        <div class="chat-buttons">
            <button onclick="sendPiobesiChat()">Invia</button>
            <button onclick="closePiobesiChat()">Chiudi</button>
        </div>
    </div>
</div>

<script>
requireRole("piobesi");

loadSegnalazioni(
    r => r.complesso === "piobesi" && r.stato === "attiva"
);

/* ================= CHAT PIobesi ================= */

let currentChatId = null;
let unsubscribeChat = null;

function openPiobesiChat(id, nome) {
    currentChatId = id;
    document.getElementById("chatTitle").innerText = "Chat â€“ " + nome;
    document.getElementById("chatPopup").style.display = "flex";

    const box = document.getElementById("chatMessages");
    box.innerHTML = "";

    if (unsubscribeChat) unsubscribeChat();

    unsubscribeChat = db.collection("segnalazioni")
        .doc(id)
        .collection("chat")
        .orderBy("timestamp")
        .onSnapshot(snap => {
            box.innerHTML = "";
            snap.forEach(d => {
                const m = d.data();
                const div = document.createElement("div");
                div.className = "chat-bubble " + (m.mittente === "admin" ? "chat-admin" : "chat-user");
                div.innerText = m.testo;
                box.appendChild(div);
            });
            box.scrollTop = box.scrollHeight;
        });
}

function closePiobesiChat(){
    document.getElementById("chatPopup").style.display = "none";
    if (unsubscribeChat) unsubscribeChat();
    unsubscribeChat = null;
    currentChatId = null;
}

function sendPiobesiChat(){
    const input = document.getElementById("chatInput");
    const txt = input.value.trim();
    if (!txt || !currentChatId) return;

    db.collection("segnalazioni")
      .doc(currentChatId)
      .collection("chat")
      .add({
          testo: txt,
          mittente: "admin",
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });

    input.value = "";
}

/* ================= AGGIUNTA ICONA CHAT ================= */
const oldLoad = loadSegnalazioni;
loadSegnalazioni = function(filterFn){
    oldLoad(filterFn);
    setTimeout(() => {
        document.querySelectorAll("#tbody tr").forEach(tr => {
            const id = tr.querySelector(".btn-green")?.getAttribute("onclick")?.match(/'(.+?)'/)?.[1];
            if (!id) return;

            const nome = tr.children[4].innerText;
            const btn = document.createElement("div");
            btn.innerText = "ðŸ’¬";
            btn.style.cursor = "pointer";
            btn.onclick = () => openPiobesiChat(id, nome);
            tr.querySelector("td:last-child div").appendChild(btn);
        });
    }, 300);
};
</script>

</body>
</html>
