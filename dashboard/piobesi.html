<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Piobesi â€“ Segnalazioni attive</title>

    <link rel="stylesheet" href="dashboard.css">

    <!-- FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <!-- CONFIG FIREBASE -->
    <script src="firebase-config.js"></script>

    <!-- LOGIN + RUOLI -->
    <script src="admin-auth.js"></script>

    <!-- LOGICA SEGNALAZIONI (PULITA, SENZA CHAT) -->
    <script src="dashboard.js"></script>

    <style>
        .logout-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            background: #ff0000;
            color: white;
            padding: 10px 18px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none;
        }

        .chat-panel {
            position: fixed;
            right: 20px;
            bottom: 20px;
            width: 360px;
            max-height: 70vh;
            background: #0e1b2a;
            border-radius: 12px;
            display: none;
            flex-direction: column;
            box-shadow: 0 10px 30px rgba(0,0,0,.4);
            z-index: 9999;
        }

        .chat-header {
            padding: 10px;
            background: #132c45;
            color: white;
            font-weight: bold;
            text-align: center;
        }

        .chat-messages {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            background: #08121e;
            font-size: 14px;
        }

        .chat-msg-admin { color: #00e676; margin-bottom: 6px; }
        .chat-msg-user { color: #90caf9; margin-bottom: 6px; }

        .chat-input {
            display: flex;
            border-top: 1px solid #1e3552;
        }

        .chat-input textarea {
            flex: 1;
            padding: 8px;
            border: none;
            resize: none;
        }

        .chat-input button {
            width: 80px;
            border: none;
            background: #00c853;
            color: #000;
            font-weight: bold;
            cursor: pointer;
        }

        .open-chat-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #0077ff;
            color: white;
            padding: 14px 18px;
            border-radius: 999px;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 6px 18px rgba(0,0,0,.4);
        }
    </style>
</head>

<body>

<a class="logout-btn" onclick="adminLogout()">Logout</a>

<div class="header">Piobesi â€“ Segnalazioni attive</div>

<div class="content">
    <table class="table">
        <thead>
        <tr>
            <th>Data</th>
            <th>Scala</th>
            <th>Piano</th>
            <th>Lato</th>
            <th>Nome</th>
            <th>Temp</th>
            <th>Tipo</th>
            <th>Descrizione</th>
            <th>Risolvi</th>
        </tr>
        </thead>
        <tbody id="tbody"></tbody>
    </table>
</div>

<!-- CHAT -->
<div class="open-chat-btn" onclick="toggleChat()">ðŸ’¬</div>

<div class="chat-panel" id="chatPanel">
    <div class="chat-header">Chat Piobesi</div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input">
        <textarea id="chatInput" placeholder="Scrivi..."></textarea>
        <button onclick="sendChat()">Invia</button>
    </div>
</div>

<script>
requireRole("piobesi");

/* SEGNALAZIONI */
loadSegnalazioni(
    r => r.complesso === "piobesi" && r.stato === "attiva"
);

/* CHAT NUOVA â€“ ISOLATA PIOBESI */
let unsubscribeChat = null;

function toggleChat() {
    const panel = document.getElementById("chatPanel");
    panel.style.display = panel.style.display === "flex" ? "none" : "flex";
    if (panel.style.display === "flex") startChat();
}

function startChat() {
    const box = document.getElementById("chatMessages");
    box.innerHTML = "";

    if (unsubscribeChat) unsubscribeChat();

    unsubscribeChat = db.collection("chats")
        .where("meta.complesso", "==", "piobesi")
        .orderBy("createdAt", "desc")
        .limit(1)
        .onSnapshot(snap => {
            snap.forEach(doc => {
                doc.ref.collection("messages")
                    .orderBy("timestamp")
                    .onSnapshot(ms => {
                        box.innerHTML = "";
                        ms.forEach(m => {
                            const d = m.data();
                            const div = document.createElement("div");
                            div.className = d.mittente === "admin"
                                ? "chat-msg-admin"
                                : "chat-msg-user";
                            div.innerText = d.testo;
                            box.appendChild(div);
                        });
                        box.scrollTop = box.scrollHeight;
                    });
            });
        });
}

function sendChat() {
    const input = document.getElementById("chatInput");
    const text = input.value.trim();
    if (!text) return;

    db.collection("chats")
        .add({
            meta: { complesso: "piobesi" },
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        })
        .then(ref => {
            ref.collection("messages").add({
                testo: text,
                mittente: "admin",
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            input.value = "";
        });
}
</script>

</body>
</html>
